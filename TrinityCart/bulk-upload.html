<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrinityCart - Bulk Sales Upload Utility</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 40px auto; padding: 20px; }
        h1, h2, h3 { color: #1e3a8a; }
        #app { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; }
        button { font-size: 1rem; padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; transition: background-color 0.2s; background-color: #2563eb; color: white; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #login-btn { background-color: #4285F4; }
        #log-output { margin-top: 20px; padding: 15px; background-color: #1f2937; color: #d1d5db; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; max-height: 500px; overflow-y: auto; }
        .step { border-top: 2px solid #d1d5db; margin-top: 2rem; padding-top: 1.5rem; }
        #drop-zone { border: 2px dashed #9ca3af; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; background-color: #f3f4f6; }
        #drop-zone.dragover { border-color: #2563eb; background-color: #eff6ff; }
    </style>
    <!-- SheetJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

    <div id="app">
        <h1>Bulk Sales Upload Utility</h1>
        <p>This tool allows an admin to generate an Excel template, fill it with sales data, and upload it to create draft sales records in the system.</p>

        <div id="auth-status">
            <p><strong>Status:</strong> <span id="status-text">Not Logged In</span></p>
            <button id="login-btn">Login with Google as Admin</button>
        </div>

        <div id="main-content" style="display: none;">
            <!-- Step 1: Download Template -->
            <div class="step">
                <h2>Step 1: Download the Template</h2>
                <p>Download the pre-formatted Excel file. Fill it out with your sales data, making sure to follow the instructions in the first sheet.</p>
                <button id="download-template-btn">Download Excel Template</button>
            </div>

            <!-- Step 2: Upload File -->
            <div class="step">
                <h2>Step 2: Upload the Completed File</h2>
                <p>Drag and drop your completed Excel file below, or click to select it.</p>
                <div id="drop-zone">
                    <p>Drag & Drop Excel File Here or Click to Select</p>
                </div>
                <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;">
            </div>
        </div>

        <pre id="log-output">Awaiting login...</pre>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script type="module">
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBAt_2gMhSPPSBi0zApb7z05ODZjMceDOk",
            authDomain: "trinitycart-9e055.firebaseapp.com",
            projectId: "trinitycart-9e055",
            storageBucket: "trinitycart-9e055.appspot.com",
            messagingSenderId: "450216949740",
            appId: "1:450216949740:web:375d45d553bfd2a541f2c9",
            measurementId: "G-57JRDMJB14"
        };

        // --- INITIALIZE FIREBASE & GET DOM ELEMENTS ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();


        
        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const statusText = document.getElementById('status-text');
        const mainContent = document.getElementById('main-content');
        const logOutput = document.getElementById('log-output');
        const downloadBtn = document.getElementById('download-template-btn');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        // --- PATHS ---
        const BASE_DOC_PATH = 'artifacts/TrinityCart-default-app-id';
        const USERS_COLLECTION_PATH = `${BASE_DOC_PATH}/users`;
        const PRODUCTS_CATALOGUE_COLLECTION_PATH = `${BASE_DOC_PATH}/productCatalogue`;
        const DRAFT_SALES_COLLECTION_PATH = `${BASE_DOC_PATH}/draftSales`;
        const SALES_CATALOGUES_COLLECTION_PATH = `${BASE_DOC_PATH}/salesCatalogues`;


        // --- HARDCODED VALUES ---
        const SALES_CATALOGUE_ID = 'Q5na6STsXh0tQYKSJBmL';
        const SALES_CATALOGUE_NAME = '2025 Christmas Catalogue';
        const SALES_SEASON_ID = 'fw3i6m4P0pioWmmumK8A';
        const SALES_SEASON_NAME = 'Christmas 2025';

        let masterData = { products: [], stores: [],cataloguePrices: new Map() };

        function log(message) {
            console.log(message);
            logOutput.textContent += `\n[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userDoc = await db.collection(USERS_COLLECTION_PATH).doc(user.uid).get();
                if (userDoc.exists && userDoc.data().role === 'admin') {
                    statusText.textContent = `Logged in as ADMIN: ${user.email}`;
                    loginBtn.style.display = 'none';
                    try {
                         log('Admin authenticated. Loading required master data...');
                        const [productsSnapshot, catalogueItemsSnapshot] = await Promise.all([
                            db.collection(PRODUCTS_CATALOGUE_COLLECTION_PATH).get(),
                            db.collection(SALES_CATALOGUES_COLLECTION_PATH).doc(SALES_CATALOGUE_ID).collection('items').get()
                        ]);
                        masterData.products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                        // Create the price lookup map
                        catalogueItemsSnapshot.forEach(doc => {
                            const item = doc.data();
                            masterData.cataloguePrices.set(item.productId, item.sellingPrice);
                        });

                        log(`✅ Loaded ${masterData.products.length} products and ${masterData.cataloguePrices.size} catalogue prices. Ready.`);
                        mainContent.style.display = 'block';
                    } catch {
                        log(`❌ FAILED to load master data: ${error.message}`);
                        statusText.textContent = 'Error loading data. Please refresh.';
                    }
                    // Assuming stores are in a config or another collection
                    masterData.stores = ['Church Store', 'Tasty Treats']; 
                    log(`✅ Loaded ${masterData.products.length} products. Ready to generate template or upload.`);
                } else {
                    statusText.textContent = `Access Denied: Not an admin.`;
                    mainContent.style.display = 'none';
                }
            } else {
                statusText.textContent = 'Not Logged In';
                mainContent.style.display = 'none';
            }
        });
        loginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));

        // --- STEP 1: TEMPLATE GENERATION ---
        downloadBtn.addEventListener('click', () => {
            log('Generating Excel template with hardcoded catalogue/season...');
            const workbook = XLSX.utils.book_new();
            
            // --- Instructions Sheet (can be more detailed) ---
            const instructionsData = [
                ['Bulk Sales Upload Instructions for:', `${SALES_CATALOGUE_NAME}`],
                [],
                ['IMPORTANT RULES:'],
                ['1. Do NOT change the headers in the "Sales Data" sheet.'],
                ['2. The "ManualVoucherNumber" MUST be filled for every single row to group items.'],
                ['3. "SaleDate", "Store", "CustomerName" only need to be filled on the FIRST line of each invoice.'],
                ['4. "DeliveryAddress" is REQUIRED if the "Store" is "Tasty Treats".'],
            ];
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
            wsInstructions['!cols'] = [{ wch: 100 }];
            XLSX.utils.book_append_sheet(workbook, wsInstructions, "Instructions");

            // --- Sales Data Sheet ---
            const headers = [
                'SaleDate (YYYY-MM-DD)', 'Store', 'CustomerName', 'ManualVoucherNumber', 'SaleType (Revenue/Sample)',
                'OrderDiscountAmount', 'OrderDiscountPercent', 'ProductName', 'Quantity', 
                'UnitPrice (Optional)', 'LineDiscountPercentage (Optional)', 'CustomerEmail (Optional)', 
                'CustomerPhone (Optional)', 'DeliveryAddress (for Tasty Treats)'
            ];
            const wsSales = XLSX.utils.aoa_to_sheet([headers]);
            wsSales['!cols'] = [
                {wch:20}, {wch:15}, {wch:20}, {wch:20}, {wch:25}, {wch:20}, {wch:20}, {wch:40}, 
                {wch:10}, {wch:20}, {wch:25}, {wch:25}, {wch:20}, {wch:40}
            ];
            XLSX.utils.book_append_sheet(workbook, wsSales, "Sales Data");

            // --- Data Validation Sheet ---
            const stores = masterData.stores || ['Church Store', 'Tasty Treats'];
            const productNames = masterData.products.map(p => p.itemName);
            const saleTypes = ['Revenue', 'Sample']; // ✅ List of valid sale types

            const validationData = [
                ['Valid Stores', 'Valid Product Names', 'Valid Sale Types'], // Add header
                ...Array(Math.max(stores.length, productNames.length, saleTypes.length)).fill([]).map((_, i) => [
                    stores[i] || '', 
                    productNames[i] || '',
                    saleTypes[i] || '' // Add sale types to the sheet
                ])
            ];
            const wsValidation = XLSX.utils.aoa_to_sheet(validationData);
            wsValidation['!cols'] = [{ hidden: true }, { hidden: true }, { hidden: true }];
            XLSX.utils.book_append_sheet(workbook, wsValidation, "DataValidation");
            
            // --- Apply Data Validation Dropdowns ---
            const storeValidation = { type: "list", formula1: `DataValidation!$A$2:$A$${stores.length + 1}` };
            const productValidation = { type: "list", formula1: `DataValidation!$B$2:$B$${productNames.length + 1}` };
            const saleTypeValidation = { type: "list", formula1: `DataValidation!$C$2:$C$${saleTypes.length + 1}` }; // ✅ New validation rule

            for (let i = 2; i <= 1002; i++) {
                if (!wsSales[`B${i}`]) wsSales[`B${i}`] = { t: 's', v: '' };
                if (!wsSales[`E${i}`]) wsSales[`E${i}`] = { t: 's', v: '' };
                if (!wsSales[`H${i}`]) wsSales[`H${i}`] = { t: 's', v: '' };
                wsSales[`B${i}`].v = storeValidation;
                wsSales[`E${i}`].v = saleTypeValidation; // ✅ Apply to SaleType column (E)
                wsSales[`H${i}`].v = productValidation; // ✅ Note: This is now column H
            }

            XLSX.utils.book_append_sheet(workbook, wsSales, "Sales Data");
            workbook.SheetNames.splice(workbook.SheetNames.indexOf("Sales Data"), 1);
            workbook.SheetNames.unshift("Sales Data");


            XLSX.writeFile(workbook, `Bulk_Sales_Upload_Template_${SALES_SEASON_NAME}.xlsx`);
            log('✅ Template downloaded.');
        });

        // --- STEP 2: UPLOAD AND PROCESSING ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFileUpload(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            log(`File selected: ${file.name}`);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    log('Reading and parsing Excel file...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true }); // Use cellDates: true
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    log(`Found ${jsonData.length} rows in the Excel file.`);
                    
                    // --- PARSE AND GROUP DATA ---
                    const invoicesMap = new Map();
                    let currentInvoiceHeader = null;
                    let validationErrors = [];

                    const productLookup = new Map(masterData.products.map(p => [p.itemName.toLowerCase(), p.id]));
                    log('products',productLookup);

                    jsonData.forEach((row, index) => {
                        const voucher = row.ManualVoucherNumber;
                        if (!voucher) return;

                        // ✅ NEW: Validate that address exists for Tasty Treats
                        if (row.Store === 'Tasty Treats' && !row['DeliveryAddress (for Tasty Treats)']) {
                            validationErrors.push(`Row ${index + 2}: DeliveryAddress is missing for a 'Tasty Treats' sale.`);
                        }

                        const saleType = row['SaleType (Revenue/Sample)']; // ✅ Get the new field

                        // ✅ Add validation for the new field
                        if (row.SaleDate && (!saleType || !['Revenue', 'Sample'].includes(saleType))) {
                            validationErrors.push(`Row ${index + 2}: Invalid or missing SaleType. Must be 'Revenue' or 'Sample'.`);
                        }

                        if (row['SaleDate (YYYY-MM-DD)']) {
                            currentInvoiceHeader = {
                                SaleDate: row['SaleDate (YYYY-MM-DD)'],
                                Store: row.Store,
                                CustomerName: row.CustomerName,
                                ManualVoucherNumber: voucher,
                                SaleType: saleType,
                                OrderDiscountAmount: row.OrderDiscountAmount || 0,
                                OrderDiscountPercent: row.OrderDiscountPercent || 0,
                                // ✅ NEW: Add the optional customer info
                                CustomerEmail: row['CustomerEmail (Optional)'] || '',
                                CustomerPhone: row['CustomerPhone (Optional)'] || '',
                                DeliveryAddress: row['DeliveryAddress (for Tasty Treats)'] || '',
                                // ✅ NEW: Add the hardcoded catalogue/season info
                                salesCatalogueId: SALES_CATALOGUE_ID,
                                salesCatalogueName: SALES_CATALOGUE_NAME,
                                salesSeasonId: SALES_SEASON_ID,
                                salesSeasonName: SALES_SEASON_NAME,
                                lineItems: []
                            };
                            invoicesMap.set(voucher, currentInvoiceHeader);
                        }
                        if (currentInvoiceHeader && currentInvoiceHeader.ManualVoucherNumber === voucher) {
                            const productName = row.ProductName;
                            const quantity = row.Quantity;

                            if (!productName || !quantity) {
                                validationErrors.push(`Row ${index + 2}: Missing required ProductName or Quantity.`);
                                return; // Skip this invalid line item
                            }

                            const productId = productLookup.get(productName.toLowerCase());

                            if (!productId) {
                                validationErrors.push(`Row ${index + 2}: Product "${productName}" not found in the master product catalogue. Please check for typos.`);
                                return; // Skip this invalid line item
                            }

                            // ✅ THE FIX: Get the price from the correct source
                            let unitPrice = row['UnitPrice (Optional)'];
                            if (unitPrice === undefined || unitPrice === null || unitPrice === '') {
                                // If user left it blank, get it from our new catalogue price map
                                unitPrice = masterData.cataloguePrices.get(productId);
                                if (unitPrice === undefined) {
                                    validationErrors.push(`Row ${index + 2}: Price for "${productName}" not found in catalogue. Please provide a UnitPrice.`);
                                    return;
                                }
                            }

                            currentInvoiceHeader.lineItems.push({
                                productId: productId,
                                ProductName: productName,
                                Quantity: Number(quantity) || 0,
                                // ✅ SANITIZE: Provide defaults for optional line item fields
                                UnitPrice: Number(unitPrice),
                                LineDiscountPercentage: row['LineDiscountPercentage (Optional)'] || 0
                            });
                        }
                    });

                    // If there were validation errors, stop and report them.
                    if (validationErrors.length > 0) {
                        log('\n❌ UPLOAD FAILED: Validation errors found in your file.');
                        log(validationErrors.join('\n'));
                        return;
                    }

                    const invoicesToUpload = Array.from(invoicesMap.values());
                    log(`Grouped data into ${invoicesToUpload.length} unique invoices.`);

                    // --- UPLOAD TO DRAFT COLLECTION ---
                    log('Starting upload to "draftSales" collection...');
                    const batch = db.batch();
                    const uploaderEmail = auth.currentUser.email;
                    const uploadedOn = firebase.firestore.FieldValue.serverTimestamp();

                    invoicesToUpload.forEach(invoice => {
                        const docRef = db.collection(DRAFT_SALES_COLLECTION_PATH).doc();
                        batch.set(docRef, {
                            status: 'Pending',
                            uploaderEmail,
                            uploadedOn,
                            invoiceData: invoice,
                            validationError: null
                        });
                    });

                    await batch.commit();
                    log('\n========================================');
                    log(`✅ SUCCESS: ${invoicesToUpload.length} draft sales have been uploaded successfully!`);
                    log('You can now go to the main application to process them.');
                    log('========================================');

                } catch (error) {
                    log(`\n❌ UPLOAD FAILED: ${error.message}`);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>

</body>
</html>
