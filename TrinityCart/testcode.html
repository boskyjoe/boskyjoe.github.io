<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced GAS CORS & API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .json-viewer { background: #1f2937; color: #e5e7eb; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-4xl mx-auto space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold mb-4 text-center">Google Apps Script API Tester</h1>
            <p class="text-gray-600 mb-6 text-center">
                Test all your vendor API endpoints with detailed response analysis
            </p>

            <!-- API URL Configuration -->
            <div class="mb-6">
                <label for="apiUrl" class="block text-gray-700 font-medium mb-2">API URL:</label>
                <input type="text" id="apiUrl" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500" 
                       value="https://script.google.com/macros/s/AKfycbyKWb0zxExuWtrvGw0kOtkoxdf5UGYzms8q0kHt4Ynn_J0U9G9g7tiY/exec" 
                       placeholder="Paste your /exec URL here">
            </div>

            <!-- User Email for POST requests -->
            <div class="mb-6">
                <label for="userEmail" class="block text-gray-700 font-medium mb-2">User Email (for POST requests):</label>
                <input type="email" id="userEmail" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500" 
                       value="test.user@example.com" placeholder="Enter your email">
            </div>

            <!-- Test Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <button id="testGetBtn" class="bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    GET Vendors
                </button>
                <button id="testAddBtn" class="bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    ADD Vendor
                </button>
                <button id="testUpdateBtn" class="bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-yellow-700 transition-colors">
                    UPDATE Vendor
                </button>
                <button id="testStatusBtn" class="bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                    SET Status
                </button>
            </div>

            <!-- Quick Connection Test -->
            <div class="text-center mb-6">
                <button id="quickTestBtn" class="bg-gray-800 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-900 transition-colors">
                    üîç Quick Connection Test
                </button>
            </div>
        </div>

        <!-- Response Display -->
        <div id="responseContainer" class="bg-white p-6 rounded-lg shadow-xl hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Response Details</h3>
            
            <!-- Status and Headers -->
            <div class="mb-4">
                <h4 class="font-bold text-gray-700 mb-2">Request Status & Headers:</h4>
                <pre id="statusOutput" class="text-sm bg-gray-100 p-3 rounded border overflow-x-auto"></pre>
            </div>

            <!-- Response Body -->
            <div class="mb-4">
                <h4 class="font-bold text-gray-700 mb-2">Response Body:</h4>
                <pre id="responseOutput" class="text-sm json-viewer p-4 rounded border overflow-x-auto whitespace-pre-wrap"></pre>
            </div>

            <!-- Analysis -->
            <div id="analysisOutput" class="mt-4 p-3 border rounded"></div>
        </div>

        <!-- Logs -->
        <div id="logContainer" class="bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Test Log</h3>
            <div id="logOutput" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button id="clearLogsBtn" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                Clear Logs
            </button>
        </div>
    </div>

    <script>
        const apiUrlInput = document.getElementById('apiUrl');
        const userEmailInput = document.getElementById('userEmail');
        const responseContainer = document.getElementById('responseContainer');
        const statusOutput = document.getElementById('statusOutput');
        const responseOutput = document.getElementById('responseOutput');
        const analysisOutput = document.getElementById('analysisOutput');
        const logOutput = document.getElementById('logOutput');

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `p-2 rounded text-sm ${type === 'error' ? 'bg-red-100 text-red-800' : type === 'success' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.insertBefore(logEntry, logOutput.firstChild);
        }

        // Response analysis function
        function analyzeResponse(response, data, requestType) {
            let analysis = '';
            
            if (response.status === 200) {
                analysis += '<div class="success">‚úÖ HTTP Status: OK (200)</div>';
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    analysis += '<div class="success">‚úÖ Content-Type: JSON</div>';
                    
                    if (data && typeof data === 'object') {
                        if (requestType === 'GET' && Array.isArray(data)) {
                            analysis += `<div class="success">‚úÖ GET Response: Array with ${data.length} items</div>`;
                        } else if (data.success === true) {
                            analysis += '<div class="success">‚úÖ Operation: Successful</div>';
                        } else if (data.success === false) {
                            analysis += `<div class="error">‚ùå Operation Failed: ${data.error || 'Unknown error'}</div>`;
                        }
                    }
                } else {
                    analysis += `<div class="error">‚ùå Content-Type: ${contentType || 'Unknown'} (Expected JSON)</div>`;
                }
            } else {
                analysis += `<div class="error">‚ùå HTTP Status: ${response.status} ${response.statusText}</div>`;
            }
            
            analysisOutput.innerHTML = analysis;
        }

        // Generic API call function
        async function makeAPICall(method, action, payload = null, requestType = 'POST') {
            const API_URL = apiUrlInput.value;
            const userEmail = userEmailInput.value;
            
            log(`Making ${method} request: ${action}`, 'info');
            
            responseContainer.classList.add('hidden');
            
            try {
                let url = API_URL;
                let options = { method };
                
                if (method === 'GET') {
                    url += `?action=${action}`;
                } else {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify({
                        action,
                        data: payload,
                        userEmail
                    });
                }
                
                const response = await fetch(url, options);
                
                // Collect headers
                let headersText = `URL: ${url}\nMethod: ${method}\n\n`;
                response.headers.forEach((value, key) => {
                    headersText += `${key}: ${value}\n`;
                });
                
                statusOutput.textContent = `Status: ${response.status} ${response.statusText}\n\n${headersText}`;
                
                let data;
                try {
                    const responseText = await response.text();
                    responseOutput.textContent = responseText;
                    
                    // Try to parse as JSON
                    data = JSON.parse(responseText);
                    responseOutput.textContent = JSON.stringify(data, null, 2);
                } catch (parseError) {
                    log(`JSON Parse Error: ${parseError.message}`, 'error');
                }
                
                analyzeResponse(response, data, requestType);
                
                if (response.ok && data) {
                    log(`${action} completed successfully`, 'success');
                } else {
                    log(`${action} failed: ${response.status} ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                responseOutput.textContent = `Network Error: ${error.message}`;
                log(`Network error: ${error.message}`, 'error');
                analysisOutput.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
            } finally {
                responseContainer.classList.remove('hidden');
            }
        }

        // Event listeners
        document.getElementById('testGetBtn').addEventListener('click', () => {
            makeAPICall('GET', 'getVendors', null, 'GET');
        });

        document.getElementById('testAddBtn').addEventListener('click', () => {
            const payload = {
                vendorName: 'Test Vendor ' + Date.now(),
                address: '123 Test Street',
                contactNo: '555-0123',
                contactEmail: 'test@vendor.com'
            };
            makeAPICall('POST', 'addVendor', payload);
        });

        document.getElementById('testUpdateBtn').addEventListener('click', () => {
            const payload = {
                vendorId: 'V1234567890', // You might need to change this to a real ID
                vendorName: 'Updated Vendor Name',
                address: '456 Updated Street',
                contactNo: '555-9876',
                contactEmail: 'updated@vendor.com'
            };
            makeAPICall('POST', 'updateVendor', payload);
        });

        document.getElementById('testStatusBtn').addEventListener('click', () => {
            const payload = {
                vendorId: 'V1234567890', // You might need to change this to a real ID
                isActive: false
            };
            makeAPICall('POST', 'setVendorStatus', payload);
        });

        document.getElementById('quickTestBtn').addEventListener('click', async () => {
            log('Running quick connection test...', 'info');
            await makeAPICall('GET', 'getVendors', null, 'GET');
        });

        document.getElementById('clearLogsBtn').addEventListener('click', () => {
            logOutput.innerHTML = '';
            log('Logs cleared', 'info');
        });

        // Initialize with a connection test
        window.addEventListener('load', () => {
            log('API Tester loaded. Click "Quick Connection Test" to verify your setup.', 'info');
        });
    </script>
</body>
</html>
