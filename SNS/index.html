<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winning Number Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDocs, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let unsubscribeWinners;

        // Firebase configuration (now using your provided values)
        const firebaseConfig = {
            apiKey: "AIzaSyCcuFTwygQ5-KujxUdv45b2TPY5yQXVVTo",
            authDomain: "snehanidhi-74ff0.firebaseapp.com",
            projectId: "snehanidhi-74ff0",
            storageBucket: "snehanidhi-74ff0.firebasestorage.app",
            messagingSenderId: "726238156431",
            appId: "1:726238156431:web:e60b0b5ed66f2d628342fa",
            measurementId: "G-7ZW0ZSQGLZ"
        };
        const appId = 'winner-generator-google-auth'; // Unique App ID for Firestore collections

        // Function to initialize Firebase
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up the authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in, show the main app
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        document.getElementById('user-info').textContent = `Logged in as: ${user.displayName || user.email}`;
                        document.getElementById('signout-button').classList.remove('hidden');
                        
                        // Set up Firestore listener for winners
                        listenForWinners(user);
                    } else {
                        // User is signed out, show the login screen
                        document.getElementById('login-container').classList.remove('hidden');
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('user-info').textContent = '';
                        document.getElementById('signout-button').classList.add('hidden');

                        // Unsubscribe from the winners listener if it exists
                        if (unsubscribeWinners) {
                            unsubscribeWinners();
                            document.getElementById('winners-list').innerHTML = ''; // Clear the list
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
            }
        };

        // Function to handle Google Sign-In
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                // Sign in with a popup
                const result = await signInWithPopup(auth, provider);
                console.log("Signed in successfully:", result.user);
            } catch (error) {
                console.error("Error signing in with Google:", error);
                document.getElementById('status').textContent = `Sign-in failed: ${error.message}`;
            }
        };

        // Function to handle Sign Out
        window.signOutGoogle = async () => {
            try {
                await signOut(auth);
                console.log("Signed out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };

        // Function to generate a random number and save it
        window.generateWinner = async () => {
            const generateButton = document.getElementById('generate-button');
            const winnerDisplay = document.getElementById('winner-number');
            const statusDisplay = document.getElementById('status');
            
            generateButton.disabled = true;
            winnerDisplay.textContent = 'Generating...';
            statusDisplay.textContent = 'Generating a new winning number...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("You must be logged in to generate a winner.");
                }

                // Simulate a slight delay for a more realistic feel
                await new Promise(resolve => setTimeout(resolve, 1000));

                const winner = Math.floor(Math.random() * 10000) + 1;
                winnerDisplay.textContent = winner;

                // Save the winning number to Firestore
                const winnersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'winners');
                await addDoc(winnersCollectionRef, {
                    number: winner,
                    generatedBy: user.displayName || user.email,
                    userId: user.uid,
                    timestamp: serverTimestamp()
                });

                statusDisplay.textContent = 'Winner saved successfully!';
            } catch (error) {
                console.error("Error generating or saving winner:", error);
                statusDisplay.textContent = `Error: ${error.message}`;
            } finally {
                generateButton.disabled = false;
            }
        };

        // Function to listen for real-time updates to the winners collection
        const listenForWinners = (user) => {
            const winnersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'winners');
            // Using query to sort by timestamp
            const q = query(winnersCollectionRef, orderBy('timestamp', 'desc'));

            // The onSnapshot listener returns an unsubscribe function
            unsubscribeWinners = onSnapshot(q, (snapshot) => {
                const winnersList = document.getElementById('winners-list');
                winnersList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.className = 'bg-white p-4 rounded-lg shadow-md mb-2';
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-800">#${data.number}</span>
                            <span class="text-sm text-gray-500">${data.generatedBy || 'Anonymous'}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            Generated by ${data.generatedBy || 'Anonymous'}
                        </div>
                    `;
                    winnersList.appendChild(li);
                });
            }, (error) => {
                console.error("Error listening to winners:", error);
            });
        };

        // Initialize Firebase on window load
        window.onload = initFirebase;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="login-container" class="hidden bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Welcome</h1>
        <p class="text-gray-600 mb-6">Please sign in to generate a winning number and see past winners.</p>
        <button onclick="signInWithGoogle()" class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-colors">
            Sign in with Google
        </button>
    </div>

    <div id="app-container" class="hidden bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Winning Number Generator</h1>
            <div class="flex items-center space-x-2">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="signout-button" onclick="signOutGoogle()" class="hidden py-1 px-3 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Sign Out</button>
            </div>
        </div>

        <div class="text-center mb-8">
            <p id="status" class="text-gray-500 mb-4 h-6">Ready to generate.</p>
            <div class="bg-blue-100 text-blue-800 font-extrabold text-6xl py-12 rounded-xl shadow-inner tracking-wider">
                <span id="winner-number">---</span>
            </div>
        </div>

        <div class="flex justify-center mb-8">
            <button id="generate-button" onclick="generateWinner()" class="py-4 px-12 bg-green-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-green-700 transition-transform transform hover:scale-105">
                Generate Winner!
            </button>
        </div>

        <div class="mt-8 border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Past Winners</h2>
            <ul id="winners-list" class="space-y-4">
                <!-- Winners will be dynamically inserted here -->
            </ul>
        </div>
    </div>

</div>
</body>
</html>
