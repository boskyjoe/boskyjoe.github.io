<!DOCTYPE-html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SSC - Sneha Nidhi Scheme</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Google Fonts: Inter for general text, Caveat for post-it note -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Caveat:wght@400;700&display=swap"
            rel="stylesheet">
        <!-- Confetti library for celebration effect -->
        <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
        <!-- Font Awesome for icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
            xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />

        <style>
            /* Apply the Inter font globally and set a light background color */
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f0f4f8;
                /* A soft, light blue-gray for the background */
                position: relative;
                /* Needed for absolute positioning of the watermark */
                min-height: 100vh;
                /* Ensure body takes full height for watermark to cover */
            }

            /* Watermark Overlay for the entire page */
            .watermark-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('images/SSC.jpg');
                background-repeat: no-repeat;
                background-position: center center;
                background-size: cover;
                opacity: 0.2;
                /* Increased opacity for more visibility */
                z-index: -1;
                /* Ensure it stays behind content */
            }

            /* Keyframes for dynamic background pattern movement */
            @keyframes pattern-move {
                0% {
                    background-position: 0 0, 10px 10px;
                }

                100% {
                    background-position: 20px 20px, 30px 30px;
                }

                /* Shift by one pattern unit */
            }

            /* Subtle diagonal stripes pattern for the main content box */
            .main-content-pattern {
                background-image: url('images/chits.png');
                background-repeat: no-repeat;
                background-position: center center;
                background-size: cover;
                /* Ensure the image fits within the container */
                opacity: 0.3;
                /* Adjust opacity for subtlety */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                border-radius: inherit;
            }

            /* Custom styles for button hover effects (Tailwind handles most, but adding a subtle scale) */
            .winner-button {
                transition: all 0.2s ease-in-out;
                /* Smooth transition for hover/active effects */
            }

            .winner-button:hover:not(:disabled) {
                transform: scale(1.05);
                /* Slightly enlarge button on hover, but not if disabled */
                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
                /* More pronounced shadow on hover */
            }

            .winner-button:active:not(:disabled) {
                transform: scale(0.98);
                /* Slight press effect on click */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                /* Reduced shadow on active */
            }

            /* Style for disabled buttons */
            .winner-button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                box-shadow: none;
                /* No shadow when disabled */
                background-color: #d1d5db !important;
                /* Tailwind's bg-gray-300 */
            }

            /* Keyframes for a subtle pulsing animation */
            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }
            }

            /* Class to apply the pulsing animation */
            .pulsing-text {
                animation: pulse 1.5s infinite ease-in-out;
            }

            /* Animation for new winner highlight within the post-it */
            @keyframes highlight-winner {
                0% {
                    background-color: transparent;
                }

                50% {
                    background-color: rgba(255, 255, 0, 0.3);
                }

                /* Brief yellow flash */
                100% {
                    background-color: transparent;
                }
            }

            .winner-highlight {
                animation: highlight-winner 1s ease-out;
            }

            /* NEW: Base hidden state for sections that will animate in */
            .section-hidden-initial {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
                max-height: 0;
                /* Important for height transition */
                padding-top: 0 !important;
                padding-bottom: 0 !important;
                margin-top: 0 !important;
                margin-bottom: 0 !important;
                overflow: hidden;
                pointer-events: none;
                /* Disable interactions when hidden */
                transition: all 0.8s ease-out;
                /* Smooth transition for revealing */
            }

            /* Inactive section styling - visual state when revealed but not currently active */
            .inactive-section {
                opacity: 0.5;
                filter: grayscale(80%);
                /* Visually desaturate */
                transition: opacity 0.5s ease-out, filter 0.5s ease-out, transform 0.5s ease-out, scale 0.5s ease-out;
                /* Smooth transition for activation */
                transform: scale(0.98);
                /* Slightly smaller when inactive */
            }

            /* Active section styling - for pre-reveal grand entrance (target state after reveal) */
            .winner-section:not(.inactive-section) {
                /* These are the target values after reveal animation from section-hidden-initial */
                opacity: 1;
                transform: translateY(0) scale(1);
                max-height: 500px;
                /* A value larger than the actual section height */
                padding: 1.5rem;
                /* Reapply original p-6 */
                margin-bottom: 2rem;
                /* Reapply original mb-8 */
                pointer-events: auto;
                /* Re-enable interactions */
                border: 3px solid #6366f1;
                /* A prominent border */
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
                /* Subtle glow */
                transition: all 0.8s ease-out, border 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            }

            /* New section styling for the consolation winners */
            #consolation-winners-section {
                display: none;
                /* Hidden initially */
                opacity: 0;
                transition: opacity 0.5s ease-in;
            }

            #consolation-winners-section.visible {
                display: block;
                opacity: 1;
            }


            /* Keyframes for individual card reveal */
            @keyframes reveal-card {
                0% {
                    opacity: 0;
                    transform: scale(0.8);
                }

                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .reveal-card-animation {
                animation: reveal-card 0.5s ease-out forwards;
            }

            /* New Keyframes for fade-out animation when resetting */
            @keyframes fade-out-text {
                from {
                    opacity: 1;
                }

                to {
                    opacity: 0;
                }
            }

            /* Class for fade-out animation */
            .fade-out-animation {
                animation: fade-out-text 0.3s ease-out forwards;
            }

            /* New Keyframes for the final number fading in */
            @keyframes final-number-fade-in {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Class to apply the final number fade-in animation */
            .final-number-reveal {
                opacity: 0;
                animation: final-number-fade-in 0.6s ease-out forwards;
            }

            /* New Keyframes for spinning icon */
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* Class for spinning icon */
            .spin-animation {
                animation: spin 3s linear infinite;
            }

            /* New Keyframes for fading out and then hiding */
            @keyframes fadeOutAndHide {
                0% {
                    opacity: 1;
                    max-height: 100px;
                    padding-top: 1.5rem;
                    padding-bottom: 1.5rem;
                    margin-top: 2rem;
                    margin-bottom: 2rem;
                }

                99% {
                    opacity: 0;
                    max-height: 0;
                    padding-top: 0;
                    padding-bottom: 0;
                    margin-top: 0;
                    margin-bottom: 0;
                }

                100% {
                    opacity: 0;
                    max-height: 0;
                    padding-top: 0;
                    padding-bottom: 0;
                    margin-top: 0;
                    margin-bottom: 0;
                    display: none;
                }
            }

            .fade-out-and-hide-animation {
                animation: fadeOutAndHide 0.7s ease-out forwards;
                overflow: hidden;
            }

            /* Countdown specific styles */
            #countdown-timer {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 8rem;
                font-weight: bold;
                color: #ef4444;
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
                display: none;
                background-color: rgba(255, 255, 255, 0.8);
                padding: 1rem 2rem;
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            }

            #countdown-timer.visible {
                opacity: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Custom styles for the 3D sponsor card content wrapper */
            .sponsor-card-content-wrapper {
                box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.2),
                    -2px -2px 5px rgba(255, 255, 255, 0.3) inset;
                border-right: 4px solid #60A5FA;
                border-bottom: 4px solid #60A5FA;
                border-top-left-radius: 0.75rem;
                border-bottom-left-radius: 0.75rem;
                border-bottom-right-radius: 0.75rem;
                position: relative;
                overflow: hidden;
            }

            /* Pseudo-element for the partial top-right border highlight */
            .sponsor-card-content-wrapper::before {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                width: 50%;
                height: 4px;
                background: linear-gradient(to right, transparent 0%, rgba(96, 165, 250, 0.6) 20%, rgba(96, 165, 250, 1) 100%);
                border-top-right-radius: 0.75rem;
                z-index: 1;
            }

            /* New class for embossed shadow on the patron image */
            .embossed-patron-shadow {
                box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3),
                    -2px -2px 5px rgba(255, 255, 255, 0.7) inset,
                    2px 2px 5px rgba(0, 0, 0, 0.1) inset;
            }

            /* New Modal Styling */
            .modal {
                display: none;
                /* Hidden by default */
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgb(0, 0, 0);
                background-color: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            }

            .modal-content {
                background-color: #fefefe;
                margin: 10% auto;
                padding: 2rem;
                border: 1px solid #888;
                width: 90%;
                max-width: 600px;
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                animation: fadeIn 0.5s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .modal-content textarea {
                width: 100%;
                min-height: 200px;
                padding: 1rem;
                font-family: monospace;
                border: 1px solid #ccc;
                border-radius: 0.5rem;
                resize: vertical;
            }

            .modal-buttons {
                display: flex;
                justify-content: flex-end;
                margin-top: 1rem;
            }

            .delete-btn {
                cursor: pointer;
                color: #ef4444;
                /* red-500 */
                transition: color 0.2s;
            }

            .delete-btn:hover {
                color: #dc2626;
                /* red-600 */
            }

            /* Custom styles for the numbered icons */
            .consolation-icon {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                /* 24px */
                font-weight: 700;
                /* Bold */
                color: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .consolation-icon.one {
                background-color: #f59e0b;
                /* amber-500 */
            }

            .consolation-icon.two {
                background-color: #10b981;
                /* emerald-500 */
            }

            .consolation-icon.three {
                background-color: #ef4444;
                /* red-500 */
            }

            /* NEW: Styles for the data tree grid table */
            #previous-winners-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
            }

            #previous-winners-table thead th {
                padding: 1rem 1rem;
                background-color: #e5e7eb;
                color: #4b5563;
                text-align: left;
                border-bottom: 2px solid #d1d5db;
            }

            #previous-winners-table tbody tr {
                transition: background-color 0.2s ease-in-out;
            }

            #previous-winners-table tbody tr.draw-row {
                background-color: #f3f4f6;
                font-weight: 600;
                cursor: pointer;
                /* Highlight that this row is clickable */
            }

            #previous-winners-table tbody tr.draw-row:hover {
                background-color: #e5e7eb;
                /* Darken on hover */
            }

            .winner-details-container {
                display: none;
                /* Initially hidden */
                background-color: #fff;
                border-left: 3px solid #60a5fa;
                border-right: 1px solid #d1d5db;
                border-bottom: 1px solid #d1d5db;
            }

            .winner-details-container.visible {
                display: table-row;
                /* Make it visible */
            }

            /* NEW: Styles for the nested "child" table */
            .winner-details-container table {
                width: 100%;
                font-size: 0.8rem;
                /* Smaller font size for a child table look */
            }

            .winner-details-container th,
            .winner-details-container td {
                padding: 0.6rem 1rem;
                /* Reduced padding for a more compact feel */
                text-align: left;
                border-bottom: 1px solid #f3f4f6;
                /* Lighter, more subtle border */
            }

            .winner-details-container th {
                background-color: #f8fafc;
                border-bottom: 1px solid #e5e7eb;
                font-weight: 600;
            }

            .winner-details-container tbody tr:last-child td {
                border-bottom: none;
                /* No border on the last row */
            }

            .tree-grid-icon {
                transition: transform 0.2s ease-in-out;
                margin-right: 0.5rem;
            }

            .tree-grid-icon.open {
                transform: rotate(90deg);
            }

            /* Styles for the new name/contact details in the cards */
            .winner-detail-info {
                font-size: 0.9rem;
                color: #374151;
                /* gray-700 */
                margin-top: 0.5rem;
                line-height: 1.25;
            }

            /* Target the custom class we added in the JavaScript options */
            .professional-theme .htCore th {
                /* Style for the table headers */
                background-color: #f4f5f7;
                /* A light, professional gray */
                font-weight: bold;
                color: #333;
                border-bottom: 2px solid #d6d8db;
            }

            .professional-theme .htCore tr:hover>td {
                /* Adds a subtle hover effect on rows */
                background-color: #eef4ff;
            }

            .professional-theme .htCore td {
                /* Ensures clean lines between all cells */
                border-bottom: 1px solid #e6e6e6;
            }

            #members-table .tabulator-row.tabulator-row-odd {
                background-color: #f2f2f2;
                /* Light gray for odd rows */
            }

            #members-table .tabulator-row.tabulator-row-even {
                background-color: #ffffff;
                /* White for even rows */
            }

            /* Add this to your main CSS file or in a <style> tag in the <head> */
            .table-wrapper {
                /* This allows the table to be scrolled horizontally if needed,
                without clipping the pagination footer. */
                overflow-x: auto;
                width: 100%;
            }

            /* Target the custom class for our table */
            .professional-handsontable .htCore th {
                /* Style for the table headers */
                background-color: #f4f5f7;
                font-weight: bold;
                color: #333;
                border-bottom: 2px solid #d6d8db;
            }

            /* THIS IS THE CORRECT WAY TO DO STRIPE ROWS IN HANDSONTABLE */
            .professional-handsontable .htCore tr:nth-child(even)>td {
                background-color: #f8f9fa;
                /* A very light gray for even rows */
            }

            .professional-handsontable .htCore tr:hover>td {
                /* Adds a subtle hover effect on rows */
                background-color: #eef4ff;
            }

            .professional-handsontable .htCore td {
                /* Ensures clean lines between all cells */
                border-bottom: 1px solid #e6e6e6;
            }

            /* Style for the entire winner row */
            .ag-row-winner {
                background-color: #fffbe6 !important;
                /* A light, noticeable yellow */
                font-weight: 500;
            }

            /* Style for the trophy icon in the winner row */
            .ag-row-winner .winner-icon {
                color: #facc15;
                /* A gold/yellow color */
                font-size: 16px;
                text-align: center;
            }

            .grid-icon-cell {
                /* Center the icon horizontally and vertically */
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0;
                /* Remove default cell padding */
            }

            /* This is the new class for rows marked for deletion */
            .ag-row-marked-for-deletion {
                background-color: #fee2e2 !important; /* A very light red (Tailwind's red-100) */
                font-weight: 500; /* Make the text slightly bolder */
            }

            /* Optional: Make the text color a bit darker for better contrast */
            .ag-row-marked-for-deletion .ag-cell {
                color: #991b1b; /* A dark red (red-800) */
            }

            /* This is the new class for inactive rows */
            .ag-row-inactive {
                background-color: #f3f4f6; /* A light gray (Tailwind's gray-100) */
                color: #6b7280; /* A muted text color (gray-500) */
            }

            /* Optional: Make the inactive rows less prominent on hover */
            .ag-row-inactive.ag-row-hover {
                background-color: #e5e7eb; /* A slightly darker gray (gray-200) */
            }
        </style>
    </head>

    <body class="min-h-screen flex flex-col items-center py-10 px-4">
        <!-- Watermark Overlay Div for the entire page -->
        <div class="watermark-overlay"></div>

        <!-- Countdown Timer Element -->
        <div id="countdown-timer"></div>

        <!-- This is the hidden canvas for the confetti effect -->
        <canvas id="confetti-canvas"
            style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; pointer-events:none;"></canvas>

        <!-- Modal for displaying messages -->
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <p id="modal-body" class="text-gray-700 mb-4"></p>
                <div class="modal-buttons">
                    <button id="modal-close-btn"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">OK</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal for delete action -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                <p id="confirmation-body" class="text-gray-700 mb-4"></p>
                <div class="modal-buttons space-x-2">
                    <button id="confirm-delete-btn"
                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Yes,
                        Delete</button>
                    <button id="cancel-delete-btn"
                        class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Main Content Container -->
        <div id="main-snehanidhi-container"
            class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-4xl w-full text-center relative z-0">
            <!-- Subtle pattern for the main content box -->
            <div class="main-content-pattern"></div>


            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Single row container for the entire header -->
                <div class="flex items-center justify-between border-b py-3">

                    <!-- Left Side: Logo and Title -->
                    <div class="flex items-center">
                        <!-- Logo -->
                        <div class="w-16 h-16 mr-4 flex-shrink-0">
                            <img src="https://static.wixstatic.com/media/df2113_f71b21a1906c4d2bace3f797f5a6a8bb~mv2.png/v1/crop/x_5,y_0,w_365,h_315/fill/w_87,h_75,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/LogoDesign-II%20(1)_edited.png"
                                alt="St. Sebastian's Church Logo" class="w-full h-full object-contain rounded-full">
                        </div>
                        
                        <!-- Title and Contact -->
                        <!-- THIS IS THE KEY CHANGE: Added flexbox classes to force left alignment -->
                        <div class="flex flex-col items-start">
                            <h1 class="text-lg md:text-xl font-extrabold text-indigo-800 whitespace-nowrap">
                                SSC - Sneha Nidhi Scheme
                            </h1>
                            <!-- Contact info is hidden on small screens to prevent clutter -->
                            <div class="hidden md:block text-gray-500 text-xs text-left">
                                <p>No:184/C, New Byppanahalli Extn, Indiranagar, Bengaluru – 560038</p>
                                <p>+91 7090424365 | stsebastianssmc@gmail.com</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Authentication Section -->
                    <div id="auth-section" class="flex items-center">
                        <!-- Sign-in Button (for logged-out users) -->
                        <button id="google-signin-btn"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-indigo-700 transition">
                            Sign in with Google
                        </button>

                        <!-- User Dropdown (for logged-in users, hidden by default) -->
                        <div id="user-profile-dropdown" class="relative hidden">
                            <!-- Dropdown Trigger -->
                            <button id="user-menu-button" class="flex items-center space-x-2 focus:outline-none">
                                <span id="user-name" class="hidden sm:inline text-sm font-medium text-gray-700"></span>
                                <img id="user-photo" class="w-8 h-8 rounded-full" src="" alt="User photo">
                            </button>

                            <!-- Dropdown Panel -->
                            <div id="user-menu-panel"
                                class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 hidden z-10">
                                <div class="px-4 py-2 border-b">
                                    <p class="text-sm font-semibold text-gray-800 truncate" id="user-name-dropdown"></p>
                                    <p class="text-xs text-gray-500 truncate" id="user-id-dropdown"></p>
                                </div>
                                <a href="./historical-entry.html" id="historical-entry-link"
                                class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                target="_blank"
                                rel="noopener noreferrer"> 
                                <i class="fa-solid fa-clock-rotate-left w-4 mr-2"></i>Old Winner Entry
                                </a>
                                <a href="#" id="signout-btn"
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>







            <!--
            NEW: Combined header with auth section
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                 Header Section (Left-aligned) 
                <div class="flex flex-col items-center justify-center md:flex-row md:justify-start mb-2">
                    <div class="w-16 h-16 md:w-20 md:h-20 mr-3 md:mr-4 flex-shrink-0">
                        <img src="https://static.wixstatic.com/media/df2113_f71b21a1906c4d2bace3f797f5a6a8bb~mv2.png/v1/crop/x_5,y_0,w_365,h_315/fill/w_87,h_75,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/LogoDesign-II%20(1)_edited.png"
                            alt="St. Sebastian's Church Logo" class="w-full h-full object-contain rounded-full">
                    </div>
                    <div class="flex flex-col items-center md:items-start text-center md:text-left">
                        <h1 class="text-xl md:text-2xl font-extrabold text-indigo-800 whitespace-nowrap">
                            SSC - Sneha Nidhi Scheme
                        </h1>
                        <div class="text-gray-600 text-xs md:text-sm">
                            <p>No:184/C, New Byppanahalli Extn, Indiranagar, Bengaluru – 560038</p>
                            <p>+91 7090424365 | stsebastianssmc@gmail.com</p>
                        </div>
                    </div>
                </div>

                Authentication Section (Right-aligned)
                <div id="auth-section"
                    class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                    <div id="user-profile" class="flex items-center space-x-2 hidden">
                        <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User profile photo">
                        <div>
                            <p id="user-name" class="text-lg font-semibold text-gray-800"></p>
                            <p id="user-id" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <button id="google-signin-btn"
                        class="winner-button px-8 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition">
                        Sign in with Google
                    </button>
                    <button id="signout-btn"
                        class="winner-button p-3 bg-gray-500 text-white font-semibold rounded-full shadow-lg hover:bg-gray-600 transition hidden relative"
                        title="Sign Out">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>-->

            <div class="mb-4 relative z-10">
                <!-- This div is now empty, as its content has been moved into the combined header -->
            </div>

            <!-- Status Message Section 
            <div id="status-message-container" class="mb-6">
                <p id="status-message" class="text-lg font-semibold text-gray-700"></p>
            </div>-->

            <!-- Status Message Section -->
            <!-- This entire block is hidden by default and will be shown by JavaScript for logged-out users -->
            <div id="status-message-container" class="hidden p-4 mb-6 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <!-- An icon provides a clear visual cue -->
                        <i id="status-message-icon" class="fa-solid fa-circle-info text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <!-- The text will be set by JavaScript -->
                        <p id="status-message" class="text-sm font-medium text-blue-800"></p>
                    </div>
                </div>
            </div>

            <!-- Single SnehaNidhi Winner Section -->
            <div id="first-place-section"
                class="winner-section bg-gradient-to-br from-purple-700 to-purple-900 p-6 rounded-lg shadow-lg mb-8 relative z-10 inactive-section">
                <h2 id="first-winner-heading"
                    class="text-3xl font-bold text-white mb-6 flex items-center justify-center">
                    <img src="images/sns1.png" alt="Sneha Nidhi Logo" class="h-12 w-12 mr-3" /> Winning Number
                </h2>
                <div class="grid grid-cols-1 gap-6 mb-6">
                    <div class="winner-card bg-purple-100 p-4 rounded-md shadow-md">
                        <h3 class="text-xl font-semibold text-purple-800">Winning Number</h3>
                        <p id="first-primary" class="text-3xl font-bold text-purple-900 mt-2">---</p>
                        <!-- NEW: Display for member details -->
                        <p id="first-primary-name" class="winner-detail-info text-gray-700">Name: ---</p>
                        <p id="first-primary-contact" class="winner-detail-info text-gray-700">Contact: ---</p>
                    </div>
                </div>
                <button id="action-button"
                    class="winner-button px-8 py-3 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out"
                    disabled>
                    Sign in to Generate Winner
                </button>
            </div>

            <!-- NEW: Consolation Winners Section -->
            <div id="consolation-winners-section"
                class="bg-gradient-to-br from-blue-700 to-blue-900 p-6 rounded-lg shadow-lg mb-8 relative z-10">
                <!-- Updated heading with ID for dynamic text -->
                <h2 id="consolation-winner-heading" class="text-3xl font-bold text-white mb-6">Consolation Winners</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- 1st Consolation Prize - now with an icon -->
                    <div class="winner-card bg-blue-100 p-4 rounded-md shadow-md">
                        <div class="flex items-center justify-center mb-2">
                            <div class="consolation-icon one">1</div>
                        </div>
                        <p id="first-consolation-primary" class="text-2xl font-bold text-blue-900 mt-2">---</p>
                        <!-- NEW: Display for member details -->
                        <p id="first-consolation-name" class="winner-detail-info text-gray-700">Name: ---</p>
                        <p id="first-consolation-contact" class="winner-detail-info text-gray-700">Contact: ---</p>
                    </div>
                    <!-- 2nd Consolation Prize - now with an icon -->
                    <div class="winner-card bg-blue-100 p-4 rounded-md shadow-md">
                        <div class="flex items-center justify-center mb-2">
                            <div class="consolation-icon two">2</div>
                        </div>
                        <p id="second-consolation-primary" class="text-2xl font-bold text-blue-900 mt-2">---</p>
                        <!-- NEW: Display for member details -->
                        <p id="second-consolation-name" class="winner-detail-info text-gray-700">Name: ---</p>
                        <p id="second-consolation-contact" class="winner-detail-info text-gray-700">Contact: ---</p>
                    </div>
                    <!-- 3rd Consolation Prize - now with an icon -->
                    <div class="winner-card bg-blue-100 p-4 rounded-md shadow-md">
                        <div class="flex items-center justify-center mb-2">
                            <div class="consolation-icon three">3</div>
                        </div>
                        <p id="third-consolation-primary" class="text-2xl font-bold text-blue-900 mt-2">---</p>
                        <!-- NEW: Display for member details -->
                        <p id="third-consolation-name" class="winner-detail-info text-gray-700">Name: ---</p>
                        <p id="third-consolation-contact" class="winner-detail-info text-gray-700">Contact: ---</p>
                    </div>
                </div>
                <button id="generate-consolation-btn"
                    class="winner-button px-8 py-3 bg-blue-700 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out"
                    disabled>
                    Generate Consolation Winners
                </button>
            </div>

            <!-- Animated "Powered By" Section -->
            <div id="powered-by-section"
                class="py-3 px-6 rounded-lg shadow-lg mt-8 mb-8 relative z-10 flex items-center justify-center space-x-2 hidden">
                <svg class="w-8 h-8 spin-animation flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                        clip-rule="evenodd"></path>
                </svg>
                <p class="text-lg md:text-xl font-bold pulsing-text whitespace-nowrap">Draw powered by DataWings
                    Solutions</p>
            </div>
            <!-- End Animated "Powered By" Section -->

            <!-- Buttons for confetti effects -->
            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 mt-6">
                <button id="reset-snehanidhi-btn"
                    class="winner-button mt-4 px-8 py-3 text-white font-semibold rounded-full shadow-lg" disabled>
                    Reset SnehaNidhi
                </button>
            </div>

            <!-- Previous Winners Section -->
            <div id="previous-winners-section" class="hidden mt-10 p-6 bg-gray-50 rounded-lg shadow-inner overflow-x-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Previous Winners</h2>
                <!-- This is the new container for the table -->
                <div class="w-full">
                    <table id="previous-winners-table" class="bg-white rounded-lg shadow-lg">
                        <thead>
                            <tr>
                                <th class="py-3 px-4">Draw Date</th>
                                <th class="py-3 px-4">Draw Details</th>
                                <th class="py-3 px-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="winners-table-body">
                            <!-- Content will be rendered here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p id="no-winners-message" class="text-center text-gray-500 mt-4 hidden">No previous winners found.</p>
            </div>
        </div>

        <!-- Sneha Nidhi Scheme Members Section -->
        <div id="members-section" class="hidden mt-10 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Sneha Nidhi Scheme Members</h2>

            <!-- Add Member Modal Form -->
            <div id="add-member-modal"
                class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                    <form id="add-member-form">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Add New Member</h3>

                        <!-- Form Fields -->
                        <div class="space-y-4">
                            <div>
                                <label for="new-sns-id" class="block text-sm font-medium text-gray-700">SNS_ID*</label>
                                <input type="text" id="new-sns-id"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    required>
                            </div>
                            <div>
                                <label for="new-member-name" class="block text-sm font-medium text-gray-700">Member
                                    Name</label>
                                <input type="text" id="new-member-name"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="new-church-contact-name"
                                    class="block text-sm font-medium text-gray-700">Church Contact Name</label>
                                <input type="text" id="new-church-contact-name"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="new-church-contact-phone"
                                    class="block text-sm font-medium text-gray-700">Contact Phone</label>
                                <input type="text" id="new-church-contact-phone"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- Error Message Placeholder -->
                        <p id="form-error-message" class="text-red-500 text-sm mt-3 hidden"></p>

                        <!-- Modal Action Buttons -->
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancel-member-button"
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                Cancel
                            </button>
                            <button type="submit" id="save-member-button"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Save Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>



            <!-- NEW: Container for all action buttons above the grid -->
            <div class="flex justify-between items-center mb-4">
                
                <!-- Left-aligned "Add New Member" button -->
                 <div id="bulk-actions-container">
                    <button id="bulk-delete-btn" class="hidden px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-red-700 flex items-center transition">
                        <i class="fa-solid fa-trash-can mr-2"></i>
                        Deactivate Selected Members
                    </button>
                </div>

                <!-- Right-aligned "Bulk Actions" container -->

                <div>
                    <button id="add-member-button" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Add New Member
                    </button>
                </div>

            </div>

            <div id="members-grid" class="ag-theme-alpine" style="height: 600px; width: 900px;"></div>


            <p id="no-members-message" class="text-center text-gray-500 mt-4 hidden">No members found.</p>
        </div>

        <!-- Footer Section -->
        <footer class="w-full bg-gray-800 text-gray-300 text-center py-4 mt-10 text-sm relative z-10">
            <p>&copy; 2025 St. Sebastian's Church. All rights reserved.</p>
            <p>Powered by <a href="#" class="text-blue-400 hover:underline">DataWings Solution</a></p>
        </footer>

        <!-- Tabulator CSS & JS -->
        <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
        <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

        <!-- Handsontable CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
        <!-- Handsontable JavaScript Library -->
        <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
            integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- Firebase SDKs -->
        <script type="module">
            // Firebase SDKs
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, onSnapshot, getDoc, where, writeBatch, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
            import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";


            // Firebase configuration hardcoded as requested
            const firebaseConfig = {
                apiKey: "AIzaSyCcuFTwygQ5-KujxUdv45b2TPY5yQXVVTo",
                authDomain: "snehanidhi-74ff0.firebaseapp.com",
                projectId: "snehanidhi-74ff0",
                storageBucket: "snehanidhi-74ff0.firebase-storage.app",
                messagingSenderId: "726238156431",
                appId: "1:726238156431:web:e60b0b5ed66f2d628342fa",
                measurementId: "G-7ZW0ZSQGLZ"
            };

            // Use a default app ID if the provided variable is not defined
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'snehanidhi-default-app-id';

            // TODO: Replace this with your Google Sheets ID
            // To find your Sheet ID, look in the URL:
            // https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit#gid=0
            const GOOGLE_SHEET_ID = '1c5Yzf_UQrCrohItdhsrENcYEqc8Cs7UtRG5OO-Gzn28';
            const GOOGLE_SHEET_NAME = 'SNSMembers';
            const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${GOOGLE_SHEET_NAME}`;

            let db = null;
            let auth = null;
            let userId = null;
            let userName = null;
            let currentWinnerData = null; // A global variable to store the winner data for the current month
            const provider = new GoogleAuthProvider();
            let unsubscribeWinnersListener = null;

            // NEW: Add variables for your confirmation modal elements
            let confirmationModal, confirmationBody, confirmDeleteBtn, cancelDeleteBtn;

            // Get references to key UI elements
            const statusMessageContainer = document.getElementById('status-message-container');
            const statusMessageElement = document.getElementById('status-message');

            const actionButton = document.getElementById('action-button');
            const resetSnehaNidhiBtn = document.getElementById('reset-snehanidhi-btn');
            const firstPlaceSection = document.getElementById('first-place-section');
            const firstWinnerHeading = document.getElementById('first-winner-heading');
            const poweredBySection = document.getElementById('powered-by-section');
            const countdownTimerElement = document.getElementById('countdown-timer');
            const confettiCanvas = document.getElementById('confetti-canvas');
            const userProfileElement = document.getElementById('user-profile');
            const userNameElement = document.getElementById('user-name');
            const userPhotoElement = document.getElementById('user-photo');
            const googleSigninBtn = document.getElementById('google-signin-btn');
            const signoutBtn = document.getElementById('signout-btn');
            const messageModal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            //const confirmationModal = document.getElementById('confirmation-modal');
            //const confirmationBody = document.getElementById('confirmation-body');
            //const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            //const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            const winnersTableBody = document.getElementById('winners-table-body');
            const noWinnersMessage = document.getElementById('no-winners-message');
            const consolationWinnersSection = document.getElementById('consolation-winners-section');
            const consolationWinnerHeading = document.getElementById('consolation-winner-heading');
            const generateConsolationBtn = document.getElementById('generate-consolation-btn');

            // NEW: Get references to the new member detail elements
            const firstPrimaryName = document.getElementById('first-primary-name');
            const firstPrimaryContact = document.getElementById('first-primary-contact');
            const firstConsolationName = document.getElementById('first-consolation-name');
            const firstConsolationContact = document.getElementById('first-consolation-contact');
            const secondConsolationName = document.getElementById('second-consolation-name');
            const secondConsolationContact = document.getElementById('second-consolation-contact');
            const thirdConsolationName = document.getElementById('third-consolation-name');
            const thirdConsolationContact = document.getElementById('third-consolation-contact');

            // Sneha Nidhi Members Table
            const membersTableBody = document.getElementById('members-table-body');
            const membersHeaderRow = document.getElementById('members-header-row');
            const noMembersMessage = document.getElementById('no-members-message');

            let addMemberButton;


            async function debugMembersPath() {
                const path = `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`;
                console.log("DEBUG: Checking Firestore path", path);

                try {
                    const membersCollectionRef = collection(db, path);
                    const snapshot = await getDocs(membersCollectionRef);
                    console.log(`DEBUG: Found ${snapshot.size} docs at ${path}`);
                    snapshot.forEach(doc => console.log("DOC ID:", doc.id, "DATA:", doc.data()));
                } catch (err) {
                    console.error("DEBUG: Firestore path failed:", err);
                }
            }


            let membersTable = null;
            let unsubscribeMembersListener = null;
            let isEditing = false;
            let bulkDeleteBtn;

            let membersHot;
            // A local copy of the data array, which we will manage
            let memberDataArray = [];

            let gridApi;

            const AppState = {
                currentUserRole: null,
            };


            // --- NEW FUNCTION ---

            // This Set will hold the ticket numbers of all "Chit Winners" for fast lookups.
            const chitWinnerTicketNumbers = new Set();


            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuPanel = document.getElementById('user-menu-panel');

            if (userMenuButton && userMenuPanel) {
                userMenuButton.addEventListener('click', () => {
                    userMenuPanel.classList.toggle('hidden');
                });

                // Optional: Close the dropdown if the user clicks outside of it
                document.addEventListener('click', (event) => {
                    if (!userMenuButton.contains(event.target) && !userMenuPanel.contains(event.target)) {
                        userMenuPanel.classList.add('hidden');
                    }
                });
            }

            /**
             * Enables or disables admin-only UI controls based on the current user's role.
             * This provides clear visual feedback to the user.
             */
            function updateAdminControls() {
                // Safety check in case the button isn't found
                console.log("DEBUG: updateAdminControls", AppState.currentUserRole);

                if (!addMemberButton) return; 

                if (AppState.currentUserRole === 'Admin') {
                    // --- USER IS AN ADMIN ---
                    addMemberButton.disabled = false;
                    // Restore the original, clickable styling
                    addMemberButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    addMemberButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    addMemberButton.title = 'Add a new member to the scheme';
                } else {
                    // --- USER IS NOT AN ADMIN (or is a 'Guest') ---
                    addMemberButton.disabled = true;
                    // Apply disabled styling for clear visual feedback
                    addMemberButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                    addMemberButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    addMemberButton.title = 'You must be an Admin to add a new member.';
                }
            }

            // NEW, BULLETPROOF VERSION
            function preprocessMembersData(snapshot) {
                const processedData = []; // Start with an empty array

                snapshot.docs.forEach(doc => {
                    try {
                        // Try to process the document
                        const data = doc.data();

                        // Check specifically if updatedDate is a Firestore Timestamp
                        // Note: You might need to import Timestamp from 'firebase/firestore' for this to be perfect
                        const isValidTimestamp = data.updatedDate && typeof data.updatedDate.toDate === 'function';

                        const member = {
                            SNS_ID: doc.id,
                            SNSMemberName: data.SNSMemberName || "",
                            ChurchContactName: data.ChurchContactName || "",
                            ChurchContactPhone: data.ChurchContactPhone || "",
                            updatedBy: data.updatedBy || "",
                            updatedDate: isValidTimestamp
                                ? data.updatedDate.toDate().toLocaleString()
                                : "" // Default to empty string if not a valid timestamp
                        };

                        processedData.push(member); // Add the successfully processed member to our array

                    } catch (error) {
                        // If ANY error occurs, log it with the specific document ID and skip it
                        console.error(`Failed to process document with ID: ${doc.id}`, error);
                        console.log('Problematic data was:', doc.data());
                    }
                });

                // Return the array of successfully processed documents
                return processedData;
            }

            // --- NEW DEDICATED FUNCTION FOR MODAL SETUP ---

            function setupAddMemberModal() {
                // Find all the necessary HTML elements for the modal
                const addMemberModal = document.getElementById('add-member-modal');
                const addMemberForm = document.getElementById('add-member-form');
                const mainAddButton = document.getElementById('add-member-button');
                const saveMemberButton = document.getElementById('save-member-button');
                const cancelMemberButton = document.getElementById('cancel-member-button');
                const formErrorMessage = document.getElementById('form-error-message');

                // Get form input fields
                const snsIdInput = document.getElementById('new-sns-id');
                const memberNameInput = document.getElementById('new-member-name');
                const churchContactNameInput = document.getElementById('new-church-contact-name');
                const churchContactPhoneInput = document.getElementById('new-church-contact-phone');

                // Check if all required elements exist before adding listeners
                if (!addMemberModal || !mainAddButton || !addMemberForm) {
                    console.warn("Add Member Modal elements not found. The 'Add New Member' feature will be disabled.");
                    return;
                }

                // --- Event Listeners ---

                // Show the modal when the main "Add New Member" button is clicked
                mainAddButton.addEventListener('click', () => {
                    addMemberForm.reset(); // Clear any previous data
                    formErrorMessage.classList.add('hidden'); // Hide any old error messages
                    addMemberModal.classList.remove('hidden');
                    snsIdInput.focus(); // Set focus to the first input field
                });

                // Hide the modal when the "Cancel" button is clicked
                cancelMemberButton.addEventListener('click', () => {
                    addMemberModal.classList.add('hidden');
                });

                // Handle the form submission when the "Save" button is clicked
                addMemberForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission
                    formErrorMessage.classList.add('hidden');

                    const newSnsId = snsIdInput.value.trim();

                    // 1. Validation
                    if (!newSnsId) {
                        formErrorMessage.textContent = 'SNS_ID is a required field.';
                        formErrorMessage.classList.remove('hidden');
                        return;
                    }

                    // 2. Check for Duplicates in Firestore
                    const newMemberRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`, newSnsId);

                    try {
                        const docSnap = await getDoc(newMemberRef);
                        if (docSnap.exists()) {
                            formErrorMessage.textContent = `Error: A member with SNS_ID '${newSnsId}' already exists.`;
                            formErrorMessage.classList.remove('hidden');
                            return;
                        }

                        // 3. If unique, prepare the new data object
                        const newMemberData = {
                            SNSMemberName: memberNameInput.value.trim(),
                            ChurchContactName: churchContactNameInput.value.trim(),
                            ChurchContactPhone: churchContactPhoneInput.value.trim(),
                            createdDate: new Date(),
                        };

                        // 4. Save the new document to Firestore
                        await setDoc(newMemberRef, newMemberData);

                        console.log(`New member document created successfully with ID: ${newSnsId}`);
                        addMemberModal.classList.add('hidden'); // Hide the modal on success
                        showModal("Success", `Member ${newSnsId} has been added successfully.`);

                    } catch (error) {
                        console.error("Error saving new member:", error);
                        formErrorMessage.textContent = 'An unexpected error occurred. Please try again.';
                        formErrorMessage.classList.remove('hidden');
                    }
                });
            }

            async function saveMemberUpdateAG(updatedRowData) {
                const memberId = updatedRowData.SNS_ID;
                if (!memberId) {
                    console.error("Cannot save update: SNS_ID is missing.", updatedRowData);
                    return;
                }
                const dataToSave = { ...updatedRowData };
                delete dataToSave.SNS_ID;
                const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`, memberId);
                try {
                    await updateDoc(docRef, dataToSave);
                    console.log(`Successfully updated member ${memberId}.`);
                } catch (error) {
                    console.error("Error saving member update:", error);
                    showModal("Error", "Your changes could not be saved.");
                }
            }

            // Function to handle deactivating a SINGLE member
            async function handleDeactivateMember(memberId) {
                const message = `Are you sure you want to deactivate member ${memberId}?`;
                const action = async () => {
                    const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${memberId}`);
                    await updateDoc(docRef, {
                        isActive: false,
                        modifiedBy: auth.currentUser.uid,
                        modifiedAt: serverTimestamp()
                    });
                    showModal("Success", `Member ${memberId} has been deactivated.`);
                };
                showGenericConfirmationModal(message, action);
            }

            // Function to handle activating a SINGLE member
            async function handleActivateMember(memberId) {
                const message = `Are you sure you want to reactivate member ${memberId}?`;
                const action = async () => {
                    const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${memberId}`);
                    await updateDoc(docRef, {
                        isActive: true,
                        modifiedBy: auth.currentUser.uid,
                        modifiedAt: serverTimestamp()
                    });
                    showModal("Success", `Member ${memberId} has been reactivated.`);
                };
                showGenericConfirmationModal(message, action);
            }


            

            /**
             * AG Grid Cell Renderer that dynamically displays an "Activate" or "Deactivate" button
             * based on the row's 'isActive' status, visible only to Admins.
             * @param {object} params - The AG Grid parameters object for the cell.
             * @returns {HTMLElement | null} The button element or null.
             */
            function actionCellRenderer(params) {
                // Immediately return if not an Admin or if it's a group row
                if (AppState.currentUserRole !== 'Admin' || !params.data) {
                    return null;
                }

                const memberId = params.data.SNS_ID;
                const isActive = params.data.isActive !== false; // Default to true if field is missing

                const button = document.createElement('button');
                
                if (isActive) {
                    // If member is Active, show a "Deactivate" button
                    button.innerHTML = '<i class="fa-solid fa-user-slash"></i>';
                    button.className = 'text-red-500 hover:text-red-700 transition focus:outline-none';
                    button.title = 'Deactivate Member';
                    button.addEventListener('click', () => handleDeactivateMember(memberId));
                } else {
                    // If member is Inactive, show an "Activate" button
                    button.innerHTML = '<i class="fa-solid fa-user-check"></i>';
                    button.className = 'text-green-500 hover:text-green-700 transition focus:outline-none';
                    button.title = 'Activate Member';
                    button.addEventListener('click', () => handleActivateMember(memberId));
                }

                // Wrap the button in a centered div
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-center h-full';
                wrapper.appendChild(button);

                return wrapper;
            }

            /**
             * Asks for confirmation and then deletes a member document from Firestore.
             * @param {string} memberId - The SNS_ID of the member to delete.
             */
            async function deleteMember(memberId) {
                if (!memberId) {
                    console.error("Delete failed: No member ID provided.");
                    return;
                }

                // 1. Define the message for the user.
                const message = `Are you sure you want to delete member ${memberId}? This action cannot be undone.`;

                // 2. Define the action to be taken on confirmation.
                const deleteAction = async () => {
                    try {
                        const docPath = `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${memberId}`;
                        const memberDocRef = doc(db, docPath);
                        
                        await deleteDoc(memberDocRef);
                        
                        console.log(`Successfully deleted member: ${memberId}`);
                        // The real-time listener on the AG Grid will handle the UI update.
                    } catch (error) {
                        console.error(`Failed to delete member ${memberId}:`, error);
                        showModal("Delete Failed", `Could not delete member. Error: ${error.message}`);
                    }
                };

                // 3. Call the generic modal with the message and the action.
                showGenericConfirmationModal(message, deleteAction);
            }



            function loadMembersWithAGGrid() {
                // Exit if the Firestore database instance is not available.
                if (!db) return;

                const path = `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`;
                console.log("Subscribing to Firestore path for AG Grid:", path);

                const membersCollectionRef = collection(db, path);

                if (unsubscribeMembersListener) unsubscribeMembersListener();

                unsubscribeMembersListener = onSnapshot(membersCollectionRef, (snapshot) => {

                    // If the Grid API doesn't exist, this is the first time loading.
                    if (!gridApi) {
                        console.log("Initializing AG Grid for the first time.");
                        const members = preprocessMembersData(snapshot);

                        // AG Grid configuration object. This is like the Handsontable constructor object.
                        const gridOptions = {
                            
                            // This sets default properties for ALL column definitions.
                            defaultColDef: {
                                filter: true,
                                floatingFilter: true,
                            },
                            // --- Column Definitions (replaces 'columns' and 'colHeaders') ---
                            // --- NEW: Enable multi-row selection ---
                            rowSelection: {
                                mode: 'multiRow',
                                enableClickSelection: false, // Note the inverted logic
                                checkboxes: true,
                                headerCheckbox: true
                            },
                            columnDefs: [
                                
                                { headerName: "SNS_ID", field: "SNS_ID", sort:'asc',  editable: false, width: 150,
                                    // Add these two properties to enable checkboxes
                                    // 2. Provide a custom comparator function for natural sorting.
                                    comparator: (valueA, valueB) => {
                                        // This function compares two values, e.g., "SSC12" and "SSC5"

                                        // Safety check for null or undefined values
                                        if (valueA == null && valueB == null) return 0;
                                        if (valueA == null) return -1; // Put nulls at the beginning
                                        if (valueB == null) return 1;  // Put nulls at the beginning

                                        // Extract the numeric part of the ID strings
                                        const numA = parseInt(valueA.replace('SSC', ''), 10);
                                        const numB = parseInt(valueB.replace('SSC', ''), 10);

                                        // Compare the numbers to get the correct sort order
                                        return numA - numB;
                                    }
                                }, // 'headerName' is the title, 'field' links to data
                                {
                                    headerName: 'Status',
                                    field: 'isActive',
                                    width: 120,
                                    // Set the initial sort order: 'desc' will put true (Active) before false (Inactive).
                                    sort: 'desc', 
                                    // Use a value formatter to display user-friendly text.
                                    valueFormatter: params => params.value === false ? 'Inactive' : 'Active'
                                },
                                { headerName: "Member Name", field: "SNSMemberName", editable: true, filter: true, width: 200,wrapText: true,autoHeight: true }, // 'filter: true' adds a filter menu
                                { headerName: "Church Contact Name", field: "ChurchContactName", width: 200, editable: true, filter: true,wrapText: true,autoHeight: true },
                                { headerName: "Contact Phone", field: "ChurchContactPhone", editable: true, width: 150, filter: true },
                                // --- NEW: Add this "Actions" column at the end ---
                                {
                                    headerName: 'Actions',
                                    width: 80,
                                    editable: false,
                                    filter: false,
                                    floatingFilter: false,
                                    // The cellRenderer is the key. It will call our custom function.
                                    cellRenderer: actionCellRenderer 
                                }
                            ],

                            // --- Data ---
                            rowData: members,

                            // --- NEW: Row Class Rules for Highlighting ---
                            rowClassRules: {
                                'ag-row-winner': (params) => {
                                    return chitWinnerTicketNumbers.has(params.data.SNS_ID);
                                },
                                'ag-row-marked-for-deletion': (params) => {
                                    return params.node.isSelected();
                                },
                                // --- THIS IS THE NEW RULE ---
                                // Apply the 'ag-row-inactive' class if the member is not active.
                                'ag-row-inactive': (params) => {
                                    return params.data.isActive === false;
                                }
                            },

                            // --- Features (replaces top-level options) ---
                            pagination: true,
                            paginationPageSize: 100,
                            domLayout: 'normal', // Use 'normal' with fixed height for best performance

                            // --- Editing and Saving (replaces 'afterChange', etc.) ---
                            onCellEditingStarted: () => {
                                isEditing = true;
                                console.log("AG Grid edit started. Blocking real-time updates.");
                            },
                            onCellEditingStopped: () => {
                                isEditing = false;
                                console.log("AG Grid edit finished. Resuming real-time updates.");
                            },
                            onCellValueChanged: (event) => {
                                // This event is much richer than Handsontable's.
                                // event.data contains the entire row object with the new value already in it.
                                console.log("AG Grid 'onCellValueChanged' event triggered.");
                                console.log("Row to be saved:", event.data);
                                saveMemberUpdateAG(event.data); // Pass the whole data object
                            },

                            // --- IMPORTANT for real-time updates ---
                            // This tells AG Grid how to find a unique row.
                            getRowId: (params) => params.data.SNS_ID,

                            // Add this event listener to force a style refresh whenever a row is selected or deselected.
                            onSelectionChanged: (event) => {
                                gridApi.redrawRows();
                            },


                        };

                        const gridDiv = document.getElementById('members-grid');
                        // Create the grid and save its API
                        gridApi = agGrid.createGrid(gridDiv, gridOptions);

                    } else {
                        // If the grid already exists, process real-time changes.
                        if (isEditing) {
                            console.log("Skipping real-time update because a cell is being edited.");
                            return;
                        }

                        // AG Grid uses transactions for updates, which is very efficient.
                        const toAdd = [];
                        const toUpdate = [];
                        const toRemove = [];

                        snapshot.docChanges().forEach((change) => {
                            const docData = { ...change.doc.data(), SNS_ID: change.doc.id };
                            if (change.type === "added") toAdd.push(docData);
                            if (change.type === "modified") toUpdate.push(docData);
                            if (change.type === "removed") toRemove.push(docData);
                        });

                        // Apply all changes in one batch
                        gridApi.applyTransaction({
                            add: toAdd,
                            update: toUpdate,
                            remove: toRemove,
                        });
                        console.log(`AG Grid updated: ${toAdd.length} added, ${toUpdate.length} updated, ${toRemove.length} removed.`);
                    }
                }, (err) => {
                    console.error("Error with real-time member listener:", err);
                    showModal("Error", "Failed to load members in real-time.");
                });
            }


            //function formatFirestoreDate(cell) {
            //    const val = cell.getValue();
            //    if (!val || !val.toDate) return "";
            //     const d = val.toDate();
            //     return `${d.getDate().toString().padStart(2, '0')}-${d.toLocaleString('default', { month: 'short' })}-${d.getFullYear()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            // }




            //function buildMembersColumns(members) {
            //    if (members.length === 0) return [];

            //    const fields = Object.keys(members[0]);
            //    return fields.map(field => {
            //        return {
            //            title: field,
            //            field: field,
            //             editor: field === "SNS_ID" ? false : "input",
            //             headerFilter: "input",
            //             headerSort: true,
            ///          };
            //      });
            //  }




            /**
             * Generates the formatted button text with the current month and year.
             * @returns {string} The formatted button text.
             */
            function getFormattedButtonText() {
                const currentDate = new Date();
                const monthName = currentDate.toLocaleString('default', { month: 'long' });
                const year = currentDate.getFullYear();
                return `Generate ${monthName} ${year} Winner`;
            }

            /**
             * Shows the custom message modal.
             * @param {string} title - The title of the modal.
             * @param {string} message - The message to display.
             */
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalBody.textContent = message;
                messageModal.style.display = 'block';
            }

            // Event listener to close the modal
            modalCloseBtn.onclick = function () {
                messageModal.style.display = 'none';
            };

            window.onclick = function (event) {
                if (event.target == messageModal || event.target == confirmationModal) {
                    event.target.style.display = 'none';
                }
            };

            async function loadMembers() {
                if (!db) return;
                const membersCollectionRef = collection(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`);
                try {
                    const snapshot = await getDocs(membersCollectionRef);
                    const members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (members.length === 0) {
                        noMembersMessage.classList.remove('hidden');
                        return;
                    }

                    // Build table header dynamically
                    const columns = Object.keys(members[0]);
                    membersHeaderRow.innerHTML = columns.map(col => `
            <th class="px-4 py-2 border-b text-left">${col}</th>
        `).join('');

                    // Populate rows
                    membersTableBody.innerHTML = '';
                    members.forEach(member => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = columns.map(col => {
                            const isEditable = col !== 'SNS_ID';
                            return `<td class="border-b px-4 py-2" contenteditable="${isEditable}" 
                            data-id="${member.id}" data-field="${col}"
                            ${!isEditable ? 'class="bg-gray-100 text-gray-600 cursor-not-allowed"' : ''}>
                            ${member[col] || ''}
                        </td>`;
                        }).join('');
                        membersTableBody.appendChild(row);
                    });

                    attachMemberTableListeners();

                } catch (err) {
                    console.error("Error loading members:", err);
                    showModal("Error", "Failed to load members from Firestore.");
                }
            }

            function attachMemberTableListeners() {
                membersTableBody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                    cell.addEventListener('blur', async (e) => {
                        const newValue = e.target.textContent.trim();
                        const docId = e.target.dataset.id;
                        const field = e.target.dataset.field;

                        try {
                            const memberDocRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`, docId);
                            await setDoc(memberDocRef, { [field]: newValue, updatedBy: auth.currentUser.uid, updatedDate: serverTimestamp() }, { merge: true });
                            console.log(`Updated ${field} for ${docId} to ${newValue}`);
                        } catch (err) {
                            console.error("Failed to update member:", err);
                            showModal("Update Failed", "Could not save changes. Check console for details.");
                        }
                    });
                });
            }


            /**
             * Fetches a user's role from the 'Users' collection in Firestore.
             * @param {Firestore} db - The initialized Firestore database instance.
             * @param {string} uid - The user's unique ID.
             * @returns {Promise<string|null>} A promise that resolves with the user's role or null.
             */
            async function getUserRole(db, uid) {
                if (!uid) return null;
                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/Users/${uid}`);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const role = docSnap.data().Role;
                        return role || 'Guest';
                    } else {
                        console.warn(`User document not found for UID: ${uid}. Assigning 'Guest' role.`);
                        return 'Guest';
                    }
                } catch (error) {
                    console.error("Error fetching user role, defaulting to 'Guest':", error);
                    return null;
                }
            }



            /**
             * Initializes Firebase and sets up the auth listener.
             * @param {object} firebaseConfig - The Firebase config object.
             */
            async function initializeFirebase(config) {
                try {
                    const firebaseApp = initializeApp(config);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    // Set up the authentication state listener
                    onAuthStateChanged(auth, async (user) => {
                        let role = 'Guest'; // Default role

                        

                        if (user) {
                            // NEW: User is signed in, so fetch their role.
                            const role = await getUserRole(db, user.uid);

                            // NEW: Store the role in our central AppState object.
                            AppState.currentUserRole = role;
                            console.log(`User role determined and set in AppState: '${AppState.currentUserRole}'`);
                        } else {
                            // NEW: User is signed out, so clear the role.
                            AppState.currentUserRole = 'Guest';
                            console.log("User signed out, role cleared in AppState.");
                        }
                        updateUIForAuthState(user,AppState.currentUserRole);
                    
                    });

                    // Authenticate with custom token if available, otherwise just rely on onAuthStateChanged
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }

                } catch (error) {
                    console.error("ERROR: Failed to initialize Firebase or authenticate:", error);
                    showModal("Initialization Failed", `The application could not connect to Firebase. Please check your network and try again. Error: ${error.message}`);
                    disableAllButtons();
                }
            }

            /**
             * Signs in the user with Google.
             */
            async function signInWithGoogle() {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    showModal("Sign-In Failed", `Could not sign you in with Google. Error: ${error.message}`);
                }
            }

            /**
            * Signs the user out of Firebase and reloads the page to reset the application state.
            */
            async function signOutUser() {
                try {
                    // 1. Sign the user out of Firebase authentication.
                    await signOut(auth);

                    // 2. Reload the page. This is the simplest and most reliable way to reset the UI.
                    // After reload, onAuthStateChanged will run and automatically set the UI to the signed-out state.
                    location.reload();

                } catch (error) {
                    console.error("Error signing out:", error);
                    showModal("Sign-Out Failed", `Could not sign you out. Error: ${error.message}`);
                }
            }


            /**
             * Displays a status message with a specific style (info, progress, etc.).
             * @param {string} message - The text to display.
             * @param {string} type - The style type ('info' or 'progress'). Defaults to 'info'.
             */
            function showStatusMessage(message, type = 'info') {
                const container = document.getElementById('status-message-container');
                const textElement = document.getElementById('status-message');
                const iconElement = document.getElementById('status-message-icon');

                if (!container || !textElement || !iconElement) {
                    console.error("Status message elements not found in the DOM.");
                    return;
                }

                // 1. Reset all possible style and icon classes
                container.classList.remove('bg-blue-50', 'border-blue-400', 'bg-yellow-50', 'border-yellow-400');
                iconElement.classList.remove('fa-circle-info', 'text-blue-500', 'fa-spinner', 'fa-spin', 'text-yellow-500');

                // 2. Apply classes based on the type
                switch (type) {
                    case 'progress':
                        container.classList.add('bg-yellow-50', 'border-yellow-400');
                        iconElement.classList.add('fa-solid', 'fa-spinner', 'fa-spin', 'text-yellow-500');
                        break;
                    case 'info':
                    default:
                        container.classList.add('bg-blue-50', 'border-blue-400');
                        iconElement.classList.add('fa-solid', 'fa-circle-info', 'text-blue-500');
                        break;
                }

                // 3. Set the message text and make the container visible
                textElement.textContent = message;
                container.classList.remove('hidden');
            }

            /**
             * Hides the status message container.
             */
            function hideStatusMessage() {
                const container = document.getElementById('status-message-container');
                if (container) {
                    container.classList.add('hidden');
                }
            }


            /**
             * Handles the bulk deletion of selected members from the AG Grid.
             */
            async function handleBulkDelete() {
                if (!gridApi) {
                    showModal("Error", "Grid is not ready.");
                    return;
                }

                // 1. Get the selected rows from the grid
                const selectedRows = gridApi.getSelectedRows();

                if (selectedRows.length === 0) {
                    showModal("No Selection", "Please select one or more members to delete using the checkboxes.");
                    return;
                }

                // 2. Define the confirmation message and the delete action
                const message = `Are you sure you want to permanently delete ${selectedRows.length} selected member(s)? This action cannot be undone.`;

                const deleteAction = async () => {
                    // Use a Firestore WriteBatch for efficient and atomic deletion
                    const batch = writeBatch(db);
                    
                    selectedRows.forEach(row => {
                        const memberId = row.SNS_ID;
                        if (memberId) {
                            const docPath = `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${memberId}`;
                            const memberDocRef = doc(db, docPath);
                             batch.update(memberDocRef, {
                                isActive: false, // The soft-delete flag
                                deletedBy: auth.currentUser.uid, // For auditing
                                deletedAt: serverTimestamp() // For auditing
                            });
                        }
                    });

                    try {
                        await batch.commit();
                        console.log(`Successfully deactivated ${selectedRows.length} members.`);
                        showModal("Success", `Successfully deactivated ${selectedRows.length} members.`);
                        // The real-time listener will automatically update the grid UI.
                    } catch (error) {
                        console.error("Bulk delete failed:", error);
                        showModal("Delete Failed", `Could not delete members. Error: ${error.message}`);
                    }
                };

                // 3. Show the generic confirmation modal
                showGenericConfirmationModal(message, deleteAction);
            }


            /**
            * Updates the UI based on the current authentication state, populating the new dropdown menu.
            * @param {object} user - The authenticated user object or null.
            */
            function updateUIForAuthState(user,role) {
                // --- Get references to all relevant UI elements ---

                // Auth Bar Elements
                const googleSigninBtn = document.getElementById('google-signin-btn');
                const userProfileDropdown = document.getElementById('user-profile-dropdown');
                const userPhoto = document.getElementById('user-photo');
                const userName = document.getElementById('user-name'); // Name next to avatar
                const userNameDropdown = document.getElementById('user-name-dropdown'); // Name inside dropdown
                const userIdDropdown = document.getElementById('user-id-dropdown'); // ID inside dropdown
                const signoutBtn = document.getElementById('signout-btn');

                const addMemberButton = document.getElementById('add-member-button');

                const historicalEntryLink = document.getElementById('historical-entry-link');

                // Other Page Elements (from your original function)
                const actionButton = document.getElementById('action-button'); // Assuming this is the ID

                // NEW: Get references to the main content sections
                const previousWinnersSection = document.getElementById('previous-winners-section');
                const membersSection = document.getElementById('members-section');


                const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

                // --- Check if essential elements exist ---
                if (!googleSigninBtn || !userProfileDropdown || !actionButton) {
                    console.error("Essential UI elements not found. Cannot update auth state.");
                    return;
                }

                if (user) {
                    // --- USER IS SIGNED IN ---
                    console.log("User is authenticated:", user.uid);
                    const displayName = user.displayName || user.email || 'Anonymous';
                    const photoURL = user.photoURL || 'https://placehold.co/40x40/94a3b8/e2e8f0?text=U'; // Default placeholder

                    hideStatusMessage();

                    // 1. Update visibility
                    userProfileDropdown.classList.remove('hidden');
                    googleSigninBtn.classList.add('hidden');

                     // NEW: Show the main content sections
                    previousWinnersSection.classList.remove('hidden');
                    membersSection.classList.remove('hidden');

                    // --- Admin Control Logic (moved from updateAdminControls) ---
                    if (role === 'Admin') {
                        addMemberButton.disabled = false;
                        addMemberButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                        addMemberButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        addMemberButton.title = 'Add a new member to the scheme';
                        // 2. Show the "Old Winner Entry" menu item
                        historicalEntryLink.classList.remove('hidden');
                        bulkDeleteBtn.classList.remove('hidden');
                    } else {
                        addMemberButton.disabled = true;
                        addMemberButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                        addMemberButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        addMemberButton.title = 'You must be an Admin to add a new member.';
                        // 2. Hide the "Old Winner Entry" menu item
                        historicalEntryLink.classList.add('hidden');
                        bulkDeleteBtn.classList.add('hidden');
                    }

                    // 2. Populate the user dropdown elements
                    userPhoto.src = photoURL;
                    userPhoto.alt = `${displayName}'s profile photo`;
                    userName.textContent = displayName; // For the trigger button
                    userNameDropdown.textContent = displayName; // For inside the panel
                    userIdDropdown.textContent = `ID: ${user.uid.substring(0, 8)}...`;

                    // 3. Set up event listeners
                    signoutBtn.onclick = signOutUser;

                    // 4. Handle the main action button (logic preserved from your original function)
                    actionButton.textContent = getFormattedButtonText();
                    actionButton.className = 'winner-button px-8 py-3 bg-purple-700 text-white font-semibold rounded-full shadow-lg hover:bg-purple-800 transition duration-300 ease-in-out';
                    actionButton.disabled = false;
                    actionButton.onclick = startWinnerGeneration;

                    // 5. Initialize app data
                    initializeSnehaNidhiData();

                } else {
                    // --- USER IS SIGNED OUT ---
                    console.log("User is not authenticated. Awaiting sign-in.");

                    // 1. Update visibility
                    userProfileDropdown.classList.add('hidden');
                    googleSigninBtn.classList.remove('hidden');

                    // NEW: Hide the main content sections
                    previousWinnersSection.classList.add('hidden');
                    membersSection.classList.add('hidden');

                    // 2. Disable the main action button (logic preserved from your original function)
                    actionButton.textContent = `Sign in to Generate Winner`;
                    actionButton.className = 'winner-button px-8 py-3 bg-gray-500 text-white font-semibold rounded-full shadow-lg';
                    actionButton.disabled = true;

                    showStatusMessage("Please sign in to start the draw and manage members.", 'info');
                }
            }

            // --- Main App Logic ---

            let allTimePickedTickets = new Set();
            console.log("Global allTimePickedTickets initialized/cleared. Size (top of script):", allTimePickedTickets.size);

            let snehanidhiTicketsWinners = [];
            let finalFirstWinner = '---';
            let consolationWinners = [];
            let confettiInstance = null;
            let confettiDrawFunctions = [];

            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            function initializeConfetti() {
                if (confettiCanvas && !confettiInstance) {
                    confettiInstance = confetti.create(confettiCanvas, { resize: true, useWorker: false });
                    console.log("DEBUG: Confetti instance created on a dedicated canvas.");
                }
            }

            function loadImageAndCreateDrawFunction(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        const drawFunction = (context) => {
                            const size = 32;
                            context.drawImage(img, -size / 2, -size / 2, size, size);
                        };
                        resolve(drawFunction);
                    };
                    img.onerror = () => reject(new Error(`Failed to load image at ${src}`));
                    img.src = src;
                });
            }

            async function preloadConfettiImages() {
                try {
                    const [coinsDrawFunction, notesDrawFunction] = await Promise.all([
                        loadImageAndCreateDrawFunction('https://placehold.co/64x64/E2E8F0/94A3B8?text=Coins'),
                        loadImageAndCreateDrawFunction('https://placehold.co/64x64/E2E8F0/94A3B8?text=Notes')
                    ]);
                    confettiDrawFunctions = [coinsDrawFunction, notesDrawFunction];
                    console.log("DEBUG: Confetti draw functions preloaded successfully.");
                } catch (error) {
                    console.error("ERROR: Failed to preload confetti images. Confetti will not show up as expected.", error);
                }
            }

            function triggerCurrencyEffect() {
                if (!confettiInstance || confettiDrawFunctions.length === 0) {
                    console.warn("Confetti instance not initialized or draw functions not loaded. Cannot fire currency effect.");
                    return;
                }

                confettiInstance({
                    particleCount: 200,
                    angle: 60,
                    spread: 70,
                    origin: { x: 0.1, y: 1 },
                    shapes: confettiDrawFunctions,
                    scalar: 2
                });

                confettiInstance({
                    particleCount: 200,
                    angle: 120,
                    spread: 70,
                    origin: { x: 0.9, y: 1 },
                    shapes: confettiDrawFunctions,
                    scalar: 2
                });

                confettiInstance({
                    particleCount: 300,
                    spread: 180,
                    ticks: 600,
                    gravity: 0.5,
                    decay: 0.94,
                    scalar: 1,
                    origin: { y: 0 },
                    shapes: confettiDrawFunctions
                });
            }

            function disableAllButtons() {
                if (actionButton) {
                    actionButton.disabled = true;
                    actionButton.textContent = "Disabled";
                }
                if (generateConsolationBtn) {
                    generateConsolationBtn.disabled = true;
                }
                if (resetSnehaNidhiBtn) {
                    resetSnehaNidhiBtn.disabled = true;
                }
                // --- ADD THIS ---
                if (addMemberButton) {
                    addMemberButton.disabled = true;
                }
            }

            async function clearDisplayedWinners() {
                const winnerElements = [
                    document.getElementById('first-primary'),
                    document.getElementById('first-consolation-primary'),
                    document.getElementById('second-consolation-primary'),
                    document.getElementById('third-consolation-primary'),
                ];

                // NEW: Elements for names and contacts
                const detailElements = [
                    firstPrimaryName, firstPrimaryContact,
                    firstConsolationName, firstConsolationContact,
                    secondConsolationName, secondConsolationContact,
                    thirdConsolationName, thirdConsolationContact
                ];

                const animations = [];
                winnerElements.forEach(element => {
                    if (element && element.textContent !== '---') {
                        element.classList.add('fade-out-animation');
                        animations.push(new Promise(resolve => {
                            element.addEventListener('animationend', () => {
                                element.classList.remove('fade-out-animation');
                                element.textContent = '---';
                                element.style.opacity = '0';
                                element.classList.remove('final-number-reveal');
                                resolve();
                            }, { once: true });
                        }));
                    } else if (element) {
                        element.textContent = '---';
                        element.style.opacity = '0';
                        element.classList.remove('final-number-reveal');
                        element.classList.remove('pulsing-text');
                        animations.push(Promise.resolve());
                    }
                });

                // Clear the new detail elements
                detailElements.forEach(element => {
                    if (element) {
                        element.textContent = '---';
                    }
                });

                await Promise.all(animations);

                if (poweredBySection) {
                    poweredBySection.classList.add('hidden');
                    poweredBySection.classList.remove('fade-out-and-hide-animation');
                    poweredBySection.classList.remove('from-purple-100', 'to-purple-200');
                    poweredBySection.classList.remove('from-teal-100', 'to-cyan-200');
                    poweredBySection.querySelector('svg').classList.remove('text-purple-700', 'text-teal-700');
                    poweredBySection.querySelector('p').classList.remove('text-purple-800', 'text-teal-800');
                    poweredBySection.style.cssText = '';
                }
                if (countdownTimerElement) {
                    countdownTimerElement.classList.remove('visible');
                    countdownTimerElement.textContent = '';
                }
            }

            /**
             * Fetches and imports member data from a Google Sheet.
             * It checks for existing members to prevent duplicates and filters out previous winners.
             * @returns {Promise<Array<string>>} A promise that resolves with the list of eligible ticket IDs.
             */
            async function importMembersFromGoogleSheets() {
                if (!db || !auth.currentUser) {
                    console.error("Firestore not initialized or user not authenticated. Cannot import data.");
                    return Promise.reject("Authentication or database not ready.");
                }

                showStatusMessage("Importing member data from Google Sheets...", 'progress');

                try {
                    const membersCollection = collection(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`);

                    // ** NEW LOGIC: Check if the collection already has data **
                    const existingMembersSnapshot = await getDocs(membersCollection);
                    if (existingMembersSnapshot.size > 0) {

                        hideStatusMessage(); 

                        console.log("Member data already exists in Firestore. Skipping Google Sheets import.");
                        showModal("Import Skipped", "Member data is already up-to-date. No new import needed from Google Sheets.");

                        // Proceed directly to fetching the eligible tickets from the existing data
                        const allTicketIds = existingMembersSnapshot.docs.map(doc => doc.id);

                        const winnersCollection = collection(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`);
                        const q = query(winnersCollection, where("prize", "==", "Chit Winner"));
                        const winnersSnapshot = await getDocs(q);

                        const previousWinnerIds = new Set();
                        winnersSnapshot.forEach(drawDoc => {
                            const drawData = drawDoc.data();
                            if (Array.isArray(drawData.winners)) {
                                drawData.winners.forEach(winner => {
                                    if (winner.prize === "Chit Winner") {
                                        previousWinnerIds.add(String(winner.ticketNumber));
                                    }
                                });
                            }
                        });

                        const eligibleTickets = allTicketIds.filter(ticketId => !previousWinnerIds.has(ticketId));

                        console.log("DEBUG: Eligible tickets for draw:", eligibleTickets);
                        hideStatusMessage();
                        return eligibleTickets;
                    }

                    // ** If the collection is empty, proceed with the full import logic **

                    const response = await fetch(GOOGLE_SHEET_URL);
                    if (!response.ok) {
                        throw new Error(`Failed to load Google Sheet data. Please ensure the sheet ID and name are correct and the sheet is publicly accessible. Status: ${response.status}`);
                    }

                    const text = await response.text();
                    const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                    const data = JSON.parse(jsonText);
                    const rows = data.table.rows;
                    const columns = data.table.cols.map(col => col.label);

                    if (columns.length === 0 || rows.length === 0) {
                        console.warn("Google Sheet is empty or columns are not labeled correctly.");
                        return [];
                    }

                    const batch = writeBatch(db);
                    let importCount = 0;
                    let updateCount = 0;

                    const existingDocsSnapshot = await getDocs(membersCollection);
                    const existingSNSIds = new Set(existingDocsSnapshot.docs.map(doc => doc.id));

                    for (const row of rows) {
                        const rowData = {};
                        row.c.forEach((cell, index) => {
                            rowData[columns[index]] = cell?.v || null;
                        });

                        if (rowData['SNS_ID']) {
                            const newDocRef = doc(membersCollection, String(rowData['SNS_ID']));
                            const memberData = {
                                ...rowData,
                                updatedBy: auth.currentUser.uid,
                                updatedDate: serverTimestamp(),
                            };

                            if (existingSNSIds.has(String(rowData['SNS_ID']))) {
                                batch.set(newDocRef, memberData, { merge: true });
                                updateCount++;
                            } else {
                                memberData.createdBy = auth.currentUser.uid;
                                memberData.createdDate = serverTimestamp();
                                batch.set(newDocRef, memberData);
                                importCount++;
                            }
                        }
                    }

                    if (importCount > 0 || updateCount > 0) {
                        await batch.commit();
                        console.log(`Successfully imported ${importCount} new members and updated ${updateCount} existing members.`);
                        showModal("Import Complete", `Successfully imported ${importCount} new members from Google Sheets and updated ${updateCount} existing members.`);
                    } else {
                        console.log(`No new members to import or update.`);
                        showModal("No Changes", "The database is already up to date with the Google Sheet. No new members or updates found.");
                    }

                    const membersSnapshot = await getDocs(membersCollection);
                    const allTicketIds = membersSnapshot.docs.map(doc => doc.id);

                    const winnersCollection = collection(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`);
                    const winnersSnapshot = await getDocs(winnersCollection);

                    const previousWinnerIds = new Set();
                    winnersSnapshot.forEach(drawDoc => {
                        const drawData = drawDoc.data();
                        if (Array.isArray(drawData.winners)) {
                            drawData.winners.forEach(winner => {
                                if (winner.prize === "Chit Winner") {
                                    previousWinnerIds.add(String(winner.ticketNumber));
                                }
                            });
                        }
                    });

                    const eligibleTickets = allTicketIds.filter(ticketId => !previousWinnerIds.has(ticketId));

                    console.log("DEBUG: Eligible tickets for draw:", eligibleTickets);
                    return eligibleTickets;

                } catch (error) {
                    console.error("ERROR: Failed to import data from Google Sheets:", error);
                    showModal("Import Failed", `Could not import data from Google Sheets. Please ensure the sheet is publicly accessible and the Sheet ID and Sheet Name in the code are correct. Error: ${error.message}`);
                    disableAllButtons();
                    hideStatusMessage();
                    return Promise.reject(error);
                }
            }


            async function checkForExistingWinner() {
                if (!db) {
                    console.error("Firestore not initialized. Cannot check for existing winner.");
                    return false;
                }
                const currentDate = new Date();
                const monthAndYear = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                const docId = monthAndYear.replace(/\s/g, '');
                const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`, docId);

                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        currentWinnerData = docSnap.data();
                        console.log("DEBUG: Winner for this month already exists.");
                        return true;
                    } else {
                        console.log("DEBUG: No winner for this month yet.");
                        return false;
                    }
                } catch (error) {
                    console.error("ERROR: Failed to check for existing winner:", error);
                    showModal("Database Error", "Failed to check for existing winner. Please check your network connection.");
                    return false;
                }
            }

            async function initializeSnehaNidhiData() {


                showStatusMessage("Loading ticket data...", 'progress');

                disableAllButtons();
                clearDisplayedWinners(); // Clear previous winners' details, including names/contacts

                // Only proceed if user is logged in
                if (!auth.currentUser) {
                    console.log("Not logged in. Awaiting user login to initialize data.");
                    showStatusMessage("Please sign in to start the draw.", 'info');
                    return;
                }

                const currentDate = new Date();
                const monthAndYear = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                if (firstWinnerHeading) {
                    firstWinnerHeading.textContent = `${monthAndYear} Winning Number`;
                }
                if (consolationWinnerHeading) {
                    consolationWinnerHeading.textContent = `${monthAndYear} Consolation Winners`;
                }

                allTimePickedTickets.clear();
                finalFirstWinner = '---';

                if (firstPlaceSection) {
                    firstPlaceSection.classList.add('inactive-section');
                }
                if (consolationWinnersSection) {
                    consolationWinnersSection.style.display = 'none';
                }
                if (resetSnehaNidhiBtn) {
                    resetSnehaNidhiBtn.disabled = true;
                    resetSnehaNidhiBtn.classList.add('bg-gray-300');
                    resetSnehaNidhiBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                }

                if (poweredBySection) {
                    poweredBySection.classList.add('hidden');
                    poweredBySection.classList.remove('fade-out-and-hide-animation');
                    poweredBySection.style.cssText = '';
                }

                if (countdownTimerElement) {
                    countdownTimerElement.classList.remove('visible');
                    countdownTimerElement.textContent = '';
                }

                initializeConfetti();
                await preloadConfettiImages();

                try {
                    snehanidhiTicketsWinners = await importMembersFromGoogleSheets();

                    console.log("DEBUG: Eligible members from Firestore:", snehanidhiTicketsWinners);

                    if (snehanidhiTicketsWinners.length < 4) {
                        showModal("Data Error", `Error: Not enough unique ticket numbers available. The database has ${snehanidhiTicketsWinners.length} eligible tickets (needs at least 4 for all prizes). Please add more members to the Google Sheet and ensure their 'WinningTerm' is blank.`);
                        hideStatusMessage();
                        disableAllButtons();
                        return;
                    }

                    const winnerExists = await checkForExistingWinner();
                    if (winnerExists && currentWinnerData) {
                        // Display existing winners
                        if (firstWinnerHeading) {
                            firstWinnerHeading.textContent = `${currentWinnerData.monthAndYear} Winning Number`;
                        }
                        if (consolationWinnerHeading) {
                            consolationWinnerHeading.textContent = `${currentWinnerData.monthAndYear} Consolation Winners`;
                        }

                        // Display the main winner's ticket number and details
                        const mainWinnerData = currentWinnerData.winners.find(w => w.prize === 'Chit Winner');
                        if (mainWinnerData) {
                            const element = document.getElementById('first-primary');
                            element.textContent = mainWinnerData.ticketNumber;
                            element.style.opacity = '1'; // FIX: Make the number visible
                            element.classList.remove('pulsing-text'); // FIX: Remove animation class
                            firstPrimaryName.textContent = `Name: ${mainWinnerData.memberDetails?.SNSMemberName || 'N/A'}`;
                            firstPrimaryContact.textContent = `Contact: ${mainWinnerData.memberDetails?.ChurchContactName || 'N/A'}`;
                        }

                        consolationWinnersSection.style.display = 'block';
                        consolationWinnersSection.classList.add('visible');

                        const consolationPrizes = currentWinnerData.winners.filter(w => w.prize.includes('Consolation Prize'));

                        if (consolationPrizes[0]) {
                            const element = document.getElementById('first-consolation-primary');
                            element.textContent = consolationPrizes[0].ticketNumber;
                            element.style.opacity = '1'; // FIX: Make the number visible
                            element.classList.remove('pulsing-text'); // FIX: Remove animation class
                            firstConsolationName.textContent = `Name: ${consolationPrizes[0].memberDetails?.SNSMemberName || 'N/A'}`;
                            firstConsolationContact.textContent = `Contact: ${consolationPrizes[0].memberDetails?.ChurchContactName || 'N/A'}`;
                        }
                        if (consolationPrizes[1]) {
                            const element = document.getElementById('second-consolation-primary');
                            element.textContent = consolationPrizes[1].ticketNumber;
                            element.style.opacity = '1'; // FIX: Make the number visible
                            element.classList.remove('pulsing-text'); // FIX: Remove animation class
                            secondConsolationName.textContent = `Name: ${consolationPrizes[1].memberDetails?.SNSMemberName || 'N/A'}`;
                            secondConsolationContact.textContent = `Contact: ${consolationPrizes[1].memberDetails?.ChurchContactName || 'N/A'}`;
                        }
                        if (consolationPrizes[2]) {
                            const element = document.getElementById('third-consolation-primary');
                            element.textContent = consolationPrizes[2].ticketNumber;
                            element.style.opacity = '1'; // FIX: Make the number visible
                            element.classList.remove('pulsing-text'); // FIX: Remove animation class
                            thirdConsolationName.textContent = `Name: ${consolationPrizes[2].memberDetails?.SNSMemberName || 'N/A'}`;
                            thirdConsolationContact.textContent = `Contact: ${consolationPrizes[2].memberDetails?.ChurchContactName || 'N/A'}`;
                        }

                        const message = `Winner for ${currentWinnerData.monthAndYear} has already been drawn. Click 'Reset SnehaNidhi' to start a new month.`;
                        showStatusMessage(message, 'info');

                        disableAllButtons();
                        if (resetSnehaNidhiBtn) {
                            resetSnehaNidhiBtn.disabled = false;
                            resetSnehaNidhiBtn.classList.remove('bg-gray-300');
                            resetSnehaNidhiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        }
                    } else {
                        const newMonthAndYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
                        showStatusMessage('Sneha Nidhi data loaded successfully! Click \'Generate Winner\' to begin.', 'info');
            
                        if (firstPlaceSection) {
                            firstPlaceSection.classList.remove('inactive-section');
                        }
                        // Re-enable the action button if a user is logged in
                        if (auth.currentUser && actionButton) {
                            actionButton.disabled = false;
                            actionButton.textContent = getFormattedButtonText();
                        }
                    }
                    // **NEW: Load Previous Winners & Members Table**
                    loadPreviousWinners();
                    loadMembersWithAGGrid()

                }
                catch (error) {
                    console.error("ERROR: Initialization failed in initializeSnehaNidhiData:", error);
                    showModal("Initialization Failed", `Failed to initialize SnehaNidhi data. Please check console for details.`);
                    hideStatusMessage();
                    disableAllButtons();
                }
            }

            function getRandomNumber(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            // UPDATED: generate a random number with the requested format
            function generateRandomAlphanumeric() {
                const randomNumber = getRandomNumber(1, 1010);
                const formattedNumber = String(randomNumber).padStart(4, '0');
                return `SSC ${formattedNumber}`;
            }

            function pickSingleUniqueTicket(sourceArray) {
                const availableTickets = sourceArray.filter(ticket => !allTimePickedTickets.has(ticket));

                if (availableTickets.length === 0) {
                    console.warn("WARNING: Not enough unique tickets available in the source pool.");
                    showModal("No Tickets Left", "All unique tickets have been drawn! Please add more tickets to the file to continue.");
                    disableAllButtons();
                    if (resetSnehaNidhiBtn) {
                        resetSnehaNidhiBtn.disabled = false;
                        resetSnehaNidhiBtn.classList.remove('bg-gray-300');
                        resetSnehaNidhiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    }
                    return "N/A";
                }

                const randomIndex = getRandomNumber(0, availableTickets.length - 1);
                const pickedTicket = availableTickets[randomIndex];
                allTimePickedTickets.add(pickedTicket);

                return pickedTicket;
            }

            async function animateNumberReveal(element, finalNumber, totalDuration) {
                const startTime = performance.now();
                let lastUpdateTime = startTime;
                const initialUpdateInterval = 20;
                const finalUpdateInterval = 300;

                element.classList.remove('final-number-reveal');
                element.classList.add('pulsing-text');

                return new Promise(resolve => {
                    function frame(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = elapsed / totalDuration;

                        if (progress >= 1) {
                            element.classList.remove('pulsing-text');
                            element.textContent = finalNumber;
                            element.classList.add('final-number-reveal');
                            resolve();
                            return;
                        }

                        let easedProgress;
                        if (progress < 0.5) {
                            easedProgress = 2 * progress * progress * progress;
                        } else {
                            easedProgress = 1 - Math.pow(-2 * progress + 2, 3) / 2;
                        }

                        const currentUpdateInterval = initialUpdateInterval + (easedProgress * (finalUpdateInterval - initialUpdateInterval));

                        if (currentTime - lastUpdateTime > currentUpdateInterval) {
                            element.textContent = generateRandomAlphanumeric();
                            lastUpdateTime = currentTime;
                        }

                        requestAnimationFrame(frame);
                    }

                    requestAnimationFrame(frame);
                });
            }

            async function startCountdown(seconds) {
                if (countdownTimerElement) {
                    countdownTimerElement.classList.add('visible');
                    for (let i = seconds; i > 0; i--) {
                        countdownTimerElement.textContent = i;
                        await delay(1000);
                    }
                    countdownTimerElement.textContent = 'GO!';
                    await delay(500);
                    countdownTimerElement.classList.remove('visible');
                    countdownTimerElement.textContent = '';
                }
            }

            /**
             * Fetches member details for a given ticket number.
             * @param {string} ticketNumber The ticket number to look up.
             * @returns {Promise<object|null>} The member data or null if not found.
             */
            async function getMemberDetails(ticketNumber) {
                if (!db) return null;
                const memberDocRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers`, ticketNumber);
                try {
                    const docSnap = await getDoc(memberDocRef);
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        console.warn(`Member data not found for ticket: ${ticketNumber}`);
                        return null;
                    }
                } catch (error) {
                    console.error(`Error fetching member details for ${ticketNumber}:`, error);
                    return null;
                }
            }

            /**
             * Saves winner data and associated member details to Firestore.
             * @param {string} winnerTicket The main winning ticket number.
             * @param {string[]} consolationTickets The consolation winning ticket numbers.
             * @param {string} monthAndYear The month and year of the draw.
             */
            async function saveWinnerToFirestore(winnerTicket, consolationTickets, monthAndYear) {
                if (!db || !auth.currentUser) {
                    console.error("Firestore not initialized or user not authenticated. Cannot save winner.");
                    return;
                }
                try {
                    // Fetch details for all winners
                    const allWinnerTickets = [winnerTicket, ...consolationTickets];
                    const winnersData = [];

                    // Correctly set the prize name to "Chit Winner"
                    const prizeNames = ['Chit Winner', 'First Consolation Prize', 'Second Consolation Prize', 'Third Consolation Prize'];

                    for (let i = 0; i < allWinnerTickets.length; i++) {
                        const ticketNumber = allWinnerTickets[i];
                        const memberDetails = await getMemberDetails(ticketNumber);

                        if (memberDetails) {
                            winnersData.push({
                                prize: prizeNames[i],
                                ticketNumber: ticketNumber,
                                memberDetails: {
                                    SNSMemberName: memberDetails.SNSMemberName,
                                    ChurchContactName: memberDetails.ChurchContactName,
                                    ChurchContactPhone: memberDetails.ChurchContactPhone
                                }
                            });
                        } else {
                            // Save a placeholder if member details couldn't be fetched
                            winnersData.push({
                                prize: prizeNames[i],
                                ticketNumber: ticketNumber,
                                memberDetails: {
                                    SNSMemberName: 'Data not found',
                                    ChurchContactName: 'Data not found',
                                    ChurchContactPhone: 'Data not found'
                                }
                            });
                        }
                    }

                    const docId = monthAndYear.replace(/\s/g, '');
                    const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`, docId);

                    await setDoc(docRef, {
                        monthAndYear: monthAndYear,
                        winners: winnersData, // Save the new structured data
                        timestamp: new Date(),
                        // 2. NEW: This saves the user's timezone identifier (e.g., 'Asia/Kolkata').
                        userTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        userId: auth.currentUser.uid,
                        userEmial:auth.currentUser.email,
                        userName: auth.currentUser.displayName || auth.currentUser.email
                    });

                    console.log("Winner and member details saved to Firestore successfully.");
                } catch (error) {
                    console.error("Error saving winner to Firestore:", error);
                    showModal("Save Error", "Failed to save the winner to the database. Please check the console for details.");
                }
            }

            /**
             * Formats a Firebase Timestamp object into a user-friendly string (DD-MON-YYYY HH:mm:ss).
             * @param {Object} firebaseTimestamp - The Firebase Timestamp object.
             * @returns {string} The formatted date string.
             */
            function formatTimestamp1(firebaseTimestamp) {
                if (!firebaseTimestamp || typeof firebaseTimestamp.toDate !== 'function') {
                    return 'N/A';
                }
                const date = firebaseTimestamp.toDate();
                const day = date.getDate().toString().padStart(2, '0');
                const month = date.toLocaleString('default', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            }



            /**
             * Formats a Firestore Timestamp into a readable string, using a specific timezone if provided.
             * @param {object} firestoreTimestamp - The timestamp object from Firestore.
             * @param {string | null} timezoneString - The IANA timezone identifier (e.g., 'Asia/Kolkata').
             * @returns {string} The formatted date string.
             */
            function formatTimestamp(firestoreTimestamp, timezoneString) {
                // Return a placeholder if the timestamp is invalid
                if (!firestoreTimestamp || typeof firestoreTimestamp.toDate !== 'function') {
                    return 'N/A';
                }

                try {
                    // Convert the Firestore Timestamp to a standard JavaScript Date object
                    const dateObject = firestoreTimestamp.toDate();

                    // Define the desired format for the output
                    const options = {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true // Use AM/PM
                    };

                    // --- THIS IS THE KEY LOGIC ---
                    // If a specific timezone is provided, use it.
                    if (timezoneString) {
                        options.timeZone = timezoneString;
                    }
                    // If timezoneString is null or undefined, toLocaleString will automatically
                    // use the CURRENT user's browser timezone, which is a safe fallback.

                    // Format the date. 'en-GB' is used for a common DD/MM/YYYY order, but you can change it.
                    return dateObject.toLocaleString('en-GB', options);

                } catch (error) {
                    // This catch block handles cases where an invalid timezone string might be provided.
                    console.error("Error formatting timestamp:", error);
                    // Fallback to a basic ISO string format on error
                    return firestoreTimestamp.toDate().toISOString().substring(0, 16);
                }
            }



            /**
             * Displays a generic confirmation modal.
             * @param {string} message - The question to ask the user (e.g., "Are you sure?").
             * @param {Function} onConfirmCallback - The async function to execute if the user clicks "Confirm".
             */
            function showGenericConfirmationModal(message, onConfirmCallback) {
                // Assuming these are global references to your modal elements
                
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmationBody = document.getElementById('confirmation-body');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                

                // 1. Set the custom message
                confirmationBody.textContent = message;

                // 2. Show the modal
                confirmationModal.style.display = 'block';

                // 3. Set up a ONE-TIME event listener for the confirm button
                confirmDeleteBtn.onclick = async () => {
                    confirmationModal.style.display = 'none'; // Hide the modal
                    await onConfirmCallback(); // Execute the provided action
                };

                // 4. Set up the cancel button listener
                cancelDeleteBtn.onclick = () => {
                    confirmationModal.style.display = 'none'; // Just hide the modal
                };
            }



            /**
             * Displays a confirmation modal before deleting a winner.
             * @param {object} rowData - The data of the row to be deleted.
             */
            function showConfirmationModal1(rowData) {
                const docId = rowData.docId;
                confirmationBody.textContent = `Are you sure you want to delete the entire winner draw for ${rowData.monthAndYear}? This action cannot be undone.`;
                confirmationModal.style.display = 'block';

                // Use a one-time event listener to handle the confirmation
                confirmDeleteBtn.onclick = async () => {
                    confirmationModal.style.display = 'none';
                    await deleteWinner(docId);
                };

                cancelDeleteBtn.onclick = () => {
                    confirmationModal.style.display = 'none';
                };
            }


            /**
             * Displays a confirmation modal before deleting a winner draw.
             * @param {object} rowData - The data of the row to be deleted.
             */
            function showConfirmationModal(rowData) {
                const message = `Are you sure you want to delete the entire winner draw for ${rowData.monthAndYear}? This action cannot be undone.`;
                
                const deleteAction = async () => {
                    await deleteWinner(rowData.docId);
                };

                showGenericConfirmationModal(message, deleteAction);
            }

            /**
             * Deletes a winner document from Firestore.
             * @param {string} docId - The ID of the document to delete.
             */
            async function deleteWinner(docId) {
                if (!db) {
                    console.error("Firestore not initialized. Cannot delete document.");
                    showModal("Error", "Database is not available. Cannot perform delete operation.");
                    return;
                }
                const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`, docId);

                try {
                    await deleteDoc(docRef);
                    console.log("Document successfully deleted with ID:", docId);
                    showModal("Success", `The winner for ${docId} was successfully deleted.`);
                } catch (error) {
                    console.error("Error removing document:", error);
                    showModal("Deletion Failed", `Failed to delete the winner. Error: ${error.message}`);
                }
            }

            /**
             * Loads and displays previous winners from Firestore using a real-time listener.
             */
            function loadPreviousWinners() {
                if (!db) {
                    console.error("Firestore not initialized. Cannot load previous winners.");
                    return;
                }

                // Unsubscribe from any previous listener to prevent duplicates
                if (unsubscribeWinnersListener) {
                    unsubscribeWinnersListener();
                }

                const winnersCollectionRef = collection(db, `/artifacts/${appId}/public/data/SnehaNidhiWinners`);

                // Listen to the collection for real-time updates
                unsubscribeWinnersListener = onSnapshot(winnersCollectionRef, (querySnapshot) => {
                    const winnersData = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        winnersData.push({
                            docId: doc.id,
                            monthAndYear: data.monthAndYear,
                            drawnBy: data.userName,
                            dateDrawn: data.timestamp,
                            userTimezone: data.userTimezone || null, // Fetch the timezone
                            winners: data.winners || [], // Now expects a structured array
                        });
                    });


                    // 1. Clear the set to ensure we have the latest data
                    chitWinnerTicketNumbers.clear();

                    // 2. Repopulate the set with "Chit Winner" ticket numbers
                    winnersData.forEach(draw => {
                        draw.winners.forEach(winner => {
                            if (winner.prize === 'Chit Winner' && winner.ticketNumber) {
                                chitWinnerTicketNumbers.add(winner.ticketNumber);
                            }
                        });
                    });
                    console.log(`Updated winner set: Found ${chitWinnerTicketNumbers.size} unique chit winners.`);


                    if (winnersData.length > 0) {
                        // Sort the winners by timestamp in descending order before rendering
                        winnersData.sort((a, b) => {
                            const dateA = a.dateDrawn ? a.dateDrawn.toDate() : new Date(0);
                            const dateB = b.dateDrawn ? b.dateDrawn.toDate() : new Date(0);
                            return dateB - dateA;
                        });
                        renderWinnersTable(winnersData);
                        noWinnersMessage.classList.add('hidden');
                    } else {
                        winnersTableBody.innerHTML = '';
                        noWinnersMessage.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("Error with real-time Firestore listener:", error);
                    showModal("Loading Error", "Failed to load previous winners data. Please check your network connection.");
                });
            }

            /**
             * Renders the winners data in a tree grid table format with a nested table for details.
             * @param {Array<Object>} winners - The array of winner data objects.
             */
            function renderWinnersTable(winners) {
                winnersTableBody.innerHTML = ''; // Clear previous content

                winners.forEach(winner => {

                    const deleteButtonHTML = AppState.currentUserRole === 'Admin'
                        ? `<i class="fa-solid fa-trash-can delete-btn text-red-500 hover:text-red-700 transition cursor-pointer" data-doc-id="${winner.docId}" title="Delete this draw"></i>`
                        : ''; // Render an empty string if not an admin

                    // Main row for the draw
                    const drawRow = document.createElement('tr');
                    drawRow.className = 'draw-row border-b border-gray-200';
                    drawRow.innerHTML = `
                    <td class="flex items-center space-x-2">
                        <i class="fa-solid fa-angle-right tree-grid-icon"></i>
                        <i class="fa-solid fa-calendar-alt text-blue-500"></i>
                        <span>${winner.monthAndYear}</span>
                    </td>
                    <td>Drawn by: ${winner.drawnBy} on ${formatTimestamp(winner.dateDrawn, winner.userTimezone)}</td>
                    <td class="text-right">
                        ${deleteButtonHTML}
                    </td>
                    `;
                    winnersTableBody.appendChild(drawRow);

                    // NEW: Nested table row for winner details
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'winner-details-container'; // This row is initially hidden
                    detailsRow.innerHTML = `
                    <td colspan="3">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4">Winning Type</th>
                                    <th class="py-2 px-4">Winning Number</th>
                                    <th class="py-2 px-4">Name</th>
                                    <th class="py-2 px-4">Church Contact Name</th>
                                    <th class="py-2 px-4">Contact Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${winner.winners.map(prizeWinner => `
                                    <tr>
                                        <td class="py-2 px-4 font-semibold">${prizeWinner.prize}</td>
                                        <td class="py-2 px-4">${prizeWinner.ticketNumber}</td>
                                        <td class="py-2 px-4">${prizeWinner.memberDetails.SNSMemberName || 'N/A'}</td>
                                        <td class="py-2 px-4">${prizeWinner.memberDetails.ChurchContactName || 'N/A'}</td>
                                        <td class="py-2 px-4">${prizeWinner.memberDetails.ChurchContactPhone || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </td>
                `;
                    winnersTableBody.appendChild(detailsRow);

                    // Add event listener to the main draw row to toggle the details
                    drawRow.addEventListener('click', () => {
                        const icon = drawRow.querySelector('.tree-grid-icon');
                        icon.classList.toggle('open');

                        detailsRow.classList.toggle('visible');
                    });

                    // Add event listener for the delete button on the main draw row
                    if (AppState.currentUserRole === 'Admin') {
                        const deleteButton = drawRow.querySelector('.delete-btn');
                        if (deleteButton) { // Always a good practice to check if the element was found
                            deleteButton.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent the row's click event from firing
                                showConfirmationModal(winner);
                            });
                        }
                    }
                });
            }

            /**
             * This function contains the core logic for the winner generation animation and data saving.
             * It is called only after a user is confirmed to be authenticated.
             */
            async function startWinnerGeneration() {
                const winnerExists = await checkForExistingWinner();
                if (winnerExists) {
                    
                    // --- 1. Show an "info" message if the winner is already drawn ---
                    const message = `A winner for ${currentWinnerData.monthAndYear} has already been drawn. Click 'Reset SnehaNidhi' to start a new month.`;
                    showStatusMessage(message, 'info');
        

                    disableAllButtons();
                    if (resetSnehaNidhiBtn) {
                        resetSnehaNidhiBtn.disabled = false;
                        resetSnehaNidhiBtn.classList.remove('bg-gray-300');
                        resetSnehaNidhiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    }
                    return;
                }

                const primaryElement = document.getElementById(`first-primary`);
                if (actionButton) {
                    actionButton.disabled = true;
                    actionButton.textContent = "Drawing...";
                }

                showStatusMessage("Drawing Winning Number...", 'progress');

                if (poweredBySection) {
                    poweredBySection.classList.remove('hidden', 'fade-out-and-hide-animation');
                    poweredBySection.style.opacity = '1';
                    poweredBySection.style.maxHeight = '100px';
                    poweredBySection.style.paddingTop = '1.5rem';
                    poweredBySection.style.paddingBottom = '1.5rem';
                    poweredBySection.style.marginTop = '2rem';
                    poweredBySection.style.marginBottom = '2rem';
                    poweredBySection.style.display = 'flex';
                    void poweredBySection.offsetWidth;

                    // Set theme for main winner
                    poweredBySection.classList.add('from-purple-100', 'to-purple-200');
                    poweredBySection.querySelector('svg').classList.add('text-purple-700');
                    poweredBySection.querySelector('p').classList.add('text-purple-800');
                    poweredBySection.classList.remove('from-teal-100', 'to-cyan-200');
                    poweredBySection.querySelector('svg').classList.remove('text-teal-700');
                    poweredBySection.querySelector('p').classList.remove('text-teal-800');
                }

                await startCountdown(3);
                const primaryWinner = pickSingleUniqueTicket(snehanidhiTicketsWinners);
                if (primaryElement) {
                    await animateNumberReveal(primaryElement, primaryWinner, 10000);
                }

                // NEW: Fetch and display member details for the main winner
                const memberDetails = await getMemberDetails(primaryWinner);
                firstPrimaryName.textContent = `Name: ${memberDetails?.SNSMemberName || 'N/A'}`;
                firstPrimaryContact.textContent = `Contact: ${memberDetails?.ChurchContactName || 'N/A'}`;


                if (poweredBySection) {
                    poweredBySection.classList.add('fade-out-and-hide-animation');
                    poweredBySection.addEventListener('animationend', function handler() {
                        poweredBySection.classList.add('hidden');
                        poweredBySection.removeEventListener('animationend', handler);
                    }, { once: true });
                }

                if (primaryWinner === "N/A") {
                    console.warn("Winning Number could not be drawn (N/A). Stopping draw.");
                    return;
                }

                finalFirstWinner = primaryWinner;
                await delay(1000);

                // --- 3. Show an "info" message prompting the next step ---
                showStatusMessage("Winning number drawn! Now, generate the consolation prizes.", 'info');


                // After main winner, enable consolation section and button
                consolationWinnersSection.style.display = 'block';
                consolationWinnersSection.classList.add('visible');
                generateConsolationBtn.disabled = false;
                actionButton.disabled = true;
                actionButton.textContent = "Winner Selected";
                triggerCurrencyEffect();
            }

            async function startConsolationGeneration() {
                generateConsolationBtn.disabled = true;
                generateConsolationBtn.textContent = "Drawing...";
                
                // --- 1. Show a "progress" message while drawing ---
                showStatusMessage("Drawing consolation winners...", 'progress');


                // Show powered by animation for consolation winners
                if (poweredBySection) {
                    poweredBySection.classList.remove('hidden', 'fade-out-and-hide-animation');
                    poweredBySection.style.opacity = '1';
                    poweredBySection.style.maxHeight = '100px';
                    poweredBySection.style.paddingTop = '1.5rem';
                    poweredBySection.style.paddingBottom = '1.5rem';
                    poweredBySection.style.marginTop = '2rem';
                    poweredBySection.style.marginBottom = '2rem';
                    poweredBySection.style.display = 'flex';
                    void poweredBySection.offsetWidth;

                    // Set theme for consolation winners
                    poweredBySection.classList.add('from-teal-100', 'to-cyan-200');
                    poweredBySection.querySelector('svg').classList.add('text-teal-700');
                    poweredBySection.querySelector('p').classList.add('text-teal-800');
                    poweredBySection.classList.remove('from-purple-100', 'to-purple-200');
                    poweredBySection.querySelector('svg').classList.remove('text-purple-700');
                    poweredBySection.querySelector('p').classList.remove('text-teal-800');
                }

                // Generate and animate consolation winners
                const consolationElements = [
                    document.getElementById('first-consolation-primary'),
                    document.getElementById('second-consolation-primary'),
                    document.getElementById('third-consolation-primary')
                ];

                // NEW: References to the name/contact elements
                const nameElements = [firstConsolationName, secondConsolationName, thirdConsolationName];
                const contactElements = [firstConsolationContact, secondConsolationContact, thirdConsolationContact];

                const consolationDraws = [];
                for (let i = 0; i < 3; i++) {
                    const winner = pickSingleUniqueTicket(snehanidhiTicketsWinners);
                    if (winner === "N/A") {
                        console.warn("Not enough tickets for all consolation prizes.");
                        hideStatusMessage();
                        break;
                    }
                    await animateNumberReveal(consolationElements[i], winner, 5000);

                    // NEW: Fetch and display member details for each consolation winner
                    const memberDetails = await getMemberDetails(winner);
                    nameElements[i].textContent = `Name: ${memberDetails?.SNSMemberName || 'N/A'}`;
                    contactElements[i].textContent = `Contact: ${memberDetails?.ChurchContactName || 'N/A'}`;

                    consolationDraws.push(winner);
                    triggerCurrencyEffect(); // Confetti after each winner is revealed
                    await delay(500); // Small delay between each consolation reveal
                }

                consolationWinners = consolationDraws;

                // Hide powered by section after all consolation winners are drawn
                if (poweredBySection) {
                    poweredBySection.classList.add('fade-out-and-hide-animation');
                    poweredBySection.addEventListener('animationend', function handler() {
                        poweredBySection.classList.add('hidden');
                        poweredBySection.removeEventListener('animationend', handler);
                    }, { once: true });
                }

                // --- 2. Show an "info" message when the process is complete ---
                showStatusMessage("All winners have been drawn! Click 'Reset SnehaNidhi' to start a new draw.", 'info');


                const currentDate = new Date();
                const monthAndYear = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                saveWinnerToFirestore(finalFirstWinner, consolationWinners, monthAndYear);

                if (resetSnehaNidhiBtn) {
                    resetSnehaNidhiBtn.disabled = false;
                    resetSnehaNidhiBtn.classList.remove('bg-gray-300');
                    resetSnehaNidhiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            }

            if (resetSnehaNidhiBtn) {
                resetSnehaNidhiBtn.addEventListener('click', () => {
                    location.reload();
                });
            }

            if (generateConsolationBtn) {
                generateConsolationBtn.addEventListener('click', startConsolationGeneration);
            }

            // Add event listener for the Google sign-in button
            if (googleSigninBtn) {
                googleSigninBtn.addEventListener('click', signInWithGoogle);
            }

            document.addEventListener('DOMContentLoaded', async () => {


                await initializeFirebase(firebaseConfig);

                bulkDeleteBtn = document.getElementById('bulk-delete-btn');
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.addEventListener('click', handleBulkDelete);
                }
                // Set up all the event listeners for the "Add New Member" modal
                setupAddMemberModal();

            });

            // Add an unload listener to clean up the Firestore listener
            window.addEventListener('beforeunload', () => {
                if (unsubscribeWinnersListener) {
                    unsubscribeWinnersListener();
                    console.log("Unsubscribed from Firestore listener.");
                }
            });

            document.addEventListener('contextmenu', event => event.preventDefault());

            document.addEventListener('keydown', event => {
                if ((event.ctrlKey || event.metaKey) && event.key === 'u') {
                    event.preventDefault();
                }
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault();
                }
                if (event.key === 'F12') {
                    event.preventDefault();
                }
            });


        </script>
    </body>

    </html>
