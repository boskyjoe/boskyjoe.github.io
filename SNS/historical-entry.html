<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Winner Data Entry</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Include Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <div class="bg-white p-8 rounded-lg shadow-lg">
            <div class="flex items-center mb-6">
                <i class="fa-solid fa-clock-rotate-left text-3xl text-indigo-600 mr-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">Historical Winner Entry</h1>
            </div>

            <!-- Admin-Only Warning -->
            <div class="mb-6 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-800">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                    <strong>Warning:</strong> This page is for administrative use only. Data saved here directly modifies the database.
                </p>
            </div>

            <form id="historical-form" class="space-y-6">
                <!-- Draw Month and Year -->
                <div>
                    <label for="draw-month" class="block text-sm font-medium text-gray-700 mb-1">Draw Month and Year*</label>
                    <input type="month" id="draw-month" name="draw-month" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Chit Winner -->
                <div>
                    <label for="chit-winner" class="block text-sm font-medium text-gray-700 mb-1">Chit Winner Ticket Number*</label>
                    <input type="text" id="chit-winner" name="chit-winner" placeholder="e.g., SSC123" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Consolation Winners -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Consolation Winners*</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="consolation-1" class="block text-sm font-medium text-gray-700 mb-1">1st Consolation</label>
                            <input type="text" id="consolation-1" name="consolation-1" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="consolation-2" class="block text-sm font-medium text-gray-700 mb-1">2nd Consolation</label>
                            <input type="text" id="consolation-2" name="consolation-2" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="consolation-3" class="block text-sm font-medium text-gray-700 mb-1">3rd Consolation</label>
                            <input type="text" id="consolation-3" name="consolation-3" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end items-center space-x-4 pt-4">
                    <button type="button" id="clear-form-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Clear Form</button>
                    <button type="submit" id="save-draw-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 flex items-center">
                        <span id="save-btn-text">Save Draw</span>
                        <i id="save-spinner" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>

            <!-- Status Message Area -->
            <div id="status-message" class="mt-6 text-center"></div>
        </div>
    </div>

    <script>
        // Firebase configuration hardcoded as requested
            const firebaseConfig = {
                apiKey: "AIzaSyCcuFTwygQ5-KujxUdv45b2TPY5yQXVVTo",
                authDomain: "snehanidhi-74ff0.firebaseapp.com",
                projectId: "snehanidhi-74ff0",
                storageBucket: "snehanidhi-74ff0.firebase-storage.app",
                messagingSenderId: "726238156431",
                appId: "1:726238156431:web:e60b0b5ed66f2d628342fa",
                measurementId: "G-7ZW0ZSQGLZ"
            };

        // --- Application Constants ---
        const appId = "snehanidhi-default-app-id"; // Your specific App ID from your path

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        /**
         * Fetches a member's details from Firestore using the v9 compat/v8 syntax.
         * @param {string} ticketNumber - The SNS_ID of the member.
         * @returns {Promise<object|null>} A promise that resolves with the member's data or null.
         */
        async function getMemberDetails(ticketNumber) {
             // Modern syntax uses helper functions
            const docRef = doc(db, `/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${ticketNumber}`);
            const docSnap = await getDoc(docRef);

            // In the modern v9 SDK, .exists() IS a function.
            return docSnap.exists() ? docSnap.data() : null;
        }

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const historicalForm = document.getElementById('historical-form');
            const saveBtn = document.getElementById('save-draw-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveSpinner = document.getElementById('save-spinner');
            const clearBtn = document.getElementById('clear-form-btn');
            const statusMessage = document.getElementById('status-message');

            // Ensure user is logged in as an Admin
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDocRef = db.doc(`/artifacts/${appId}/Users/${user.uid}`);
                    const userDoc = await userDocRef.get();
                    
                    // --- THIS IS THE FIX ---
                    // Changed userDoc.exists() to userDoc.exists
                    if (!userDoc.exists || userDoc.data().Role !== 'Admin') {
                        saveBtn.disabled = true;
                        statusMessage.innerHTML = `<p class="text-red-600 font-bold">Access Denied: You must be an Admin to use this page.</p>`;
                    }
                } else {
                    saveBtn.disabled = true;
                    statusMessage.innerHTML = `<p class="text-red-600 font-bold">Access Denied: Please sign in as an Admin.</p>`;
                }
            });

            // Clear form button
            clearBtn.addEventListener('click', () => {
                historicalForm.reset();
                statusMessage.innerHTML = '';
            });

            // Form submission handler
            historicalForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                statusMessage.innerHTML = ''; // Clear previous messages

                // Disable button and show spinner
                saveBtn.disabled = true;
                saveBtnText.textContent = 'Saving...';
                saveSpinner.classList.remove('hidden');

                const monthInputValue = document.getElementById('draw-month').value;
                const winnerTicket = document.getElementById('chit-winner').value.trim();
                const consolationTickets = [
                    document.getElementById('consolation-1').value.trim(),
                    document.getElementById('consolation-2').value.trim(),
                    document.getElementById('consolation-3').value.trim()
                ];

                // --- Validation ---
                if (!monthInputValue || !winnerTicket || consolationTickets.some(t => !t)) {
                    statusMessage.innerHTML = `<p class="text-red-600">Error: All fields are required.</p>`;
                    resetSaveButton();
                    return;
                }

                // Format the month and year for display and ID
                const [year, month] = monthInputValue.split('-');
                const date = new Date(year, month - 1);
                const monthAndYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                try {
                    // Call the save logic
                    await saveHistoricalWinner(winnerTicket, consolationTickets, monthAndYear);
                    statusMessage.innerHTML = `<p class="text-green-600 font-bold">Success! Draw for ${monthAndYear} has been saved.</p>`;
                    historicalForm.reset();
                } catch (error) {
                    console.error("Error during historical save:", error);
                    statusMessage.innerHTML = `<p class="text-red-600">Save Failed: ${error.message}</p>`;
                } finally {
                    resetSaveButton();
                }
            });

            function resetSaveButton() {
                saveBtn.disabled = false;
                saveBtnText.textContent = 'Save Draw';
                saveSpinner.classList.add('hidden');
            }
        });

        // --- Firestore Save Logic (Adapted from your function) ---
        async function saveHistoricalWinner(winnerTicket, consolationTickets, monthAndYear) {
            if (!auth.currentUser) {
                throw new Error("User not authenticated.");
            }

            const allWinnerTickets = [winnerTicket, ...consolationTickets];
            const winnersData = [];
            const prizeNames = ['Chit Winner', 'First Consolation Prize', 'Second Consolation Prize', 'Third Consolation Prize'];

            for (let i = 0; i < allWinnerTickets.length; i++) {
                const ticketNumber = allWinnerTickets[i];
                const memberDetails = await getMemberDetails(ticketNumber);

                winnersData.push({
                    prize: prizeNames[i],
                    ticketNumber: ticketNumber,
                    memberDetails: {
                        SNSMemberName: memberDetails?.SNSMemberName || 'N/A',
                        ChurchContactName: memberDetails?.ChurchContactName || 'N/A',
                        ChurchContactPhone: memberDetails?.ChurchContactPhone || 'N/A'
                    }
                });
            }

            const docId = monthAndYear.replace(/\s/g, '');
            const docRef = db.doc(`/artifacts/${appId}/public/data/SnehaNidhiWinners/${docId}`);

            await docRef.set({
                monthAndYear: monthAndYear,
                winners: winnersData,
                timestamp: new Date(),
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                userName: auth.currentUser.displayName || auth.currentUser.email
            });
        }
    </script>
</body>
</html>
