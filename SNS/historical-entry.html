<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Winner Data Entry</title>
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Include Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">

        <!-- NEW: Authentication Section -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">Authentication</h2>
                    <p id="auth-status" class="text-sm text-gray-500">Please sign in to continue.</p>
                </div>
                <!-- This container will show the user's profile when logged in -->
                <div id="user-profile-section" class="hidden items-center space-x-3">
                    <img id="user-photo" class="w-10 h-10 rounded-full" alt="User photo">
                    <span id="user-name" class="text-sm font-medium text-gray-700"></span>
                    <button id="sign-out-btn" title="Sign Out" class="text-gray-500 hover:text-red-600">
                        <i class="fa-solid fa-right-from-bracket text-xl"></i>
                    </button>
                </div>
                <!-- This button will be shown when the user is logged out -->
                <button id="google-signin-btn"
                    class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 flex items-center">
                    <i class="fa-brands fa-google mr-2"></i>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Existing Data Entry Form Section -->
        <div class="bg-white p-8 rounded-lg shadow-lg">
            <div class="flex items-center mb-6">
                <i class="fa-solid fa-clock-rotate-left text-3xl text-indigo-600 mr-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">Historical Winner Entry</h1>
            </div>

            <!-- Admin-Only Warning -->
            <div class="mb-6 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-800">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                    <strong>Warning:</strong> This page is for administrative use only.
                </p>
            </div>

            <form id="historical-form" class="space-y-6">
                <!-- Draw Month and Year -->
                <div>
                    <label for="draw-month" class="block text-sm font-medium text-gray-700 mb-1">Draw Month and
                        Year*</label>
                    <input type="month" id="draw-month" name="draw-month" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="draw-timestamp" class="block text-sm font-medium text-gray-700 mb-1">Specific Draw Date & Time*</label>
                    <input type="datetime-local" id="draw-timestamp" name="draw-timestamp" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Chit Winner -->
                <div>
                    <label for="chit-winner" class="block text-sm font-medium text-gray-700 mb-1">Chit Winner Ticket
                        Number*</label>
                    <input type="text" id="chit-winner" name="chit-winner" placeholder="e.g., SSC123" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Consolation Winners -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Consolation Winners*</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="consolation-1" class="block text-sm font-medium text-gray-700 mb-1">1st
                                Consolation</label>
                            <input type="text" id="consolation-1" name="consolation-1" placeholder="e.g., SSC123" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="consolation-2" class="block text-sm font-medium text-gray-700 mb-1">2nd
                                Consolation</label>
                            <input type="text" id="consolation-2" name="consolation-2" placeholder="e.g., SSC123" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="consolation-3" class="block text-sm font-medium text-gray-700 mb-1">3rd
                                Consolation</label>
                            <input type="text" id="consolation-3" name="consolation-3" placeholder="e.g., SSC123" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end items-center space-x-4 pt-4">
                    <button type="button" id="clear-form-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Clear Form</button>
                    <button type="submit" id="save-draw-btn"
                        class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-sm hover:bg-indigo-700 flex items-center">
                        <span id="save-btn-text">Save Draw</span>
                        <i id="save-spinner" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>

            <!-- Status Message Area -->
            <div id="status-message" class="mt-6 text-center"></div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyCcuFTwygQ5-KujxUdv45b2TPY5yQXVVTo",
                authDomain: "snehanidhi-74ff0.firebaseapp.com",
                projectId: "snehanidhi-74ff0",
                storageBucket: "snehanidhi-74ff0.firebase-storage.app",
                messagingSenderId: "726238156431",
                appId: "1:726238156431:web:e60b0b5ed66f2d628342fa",
                measurementId: "G-7ZW0ZSQGLZ"
            };

        // --- Application Constants ---
        const appId = "snehanidhi-default-app-id";

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Get Element References ---
            const historicalForm = document.getElementById('historical-form');
            const saveBtn = document.getElementById('save-draw-btn');
            const clearBtn = document.getElementById('clear-form-btn');
            const statusMessage = document.getElementById('status-message');

            // New Auth UI Elements
            const googleSigninBtn = document.getElementById('google-signin-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const userProfileSection = document.getElementById('user-profile-section');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const authStatus = document.getElementById('auth-status');

            // --- Event Listeners ---
            googleSigninBtn.addEventListener('click', signInWithGoogle);
            signOutBtn.addEventListener('click', signOutUser);
            clearBtn.addEventListener('click', () => {
                historicalForm.reset();
                statusMessage.innerHTML = '';
            });
            historicalForm.addEventListener('submit', handleFormSubmit);

            // --- Central Authentication Handler ---
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    googleSigninBtn.classList.add('hidden');
                    userProfileSection.style.display = 'flex';

                    userPhoto.src = user.photoURL;
                    userName.textContent = user.displayName;

                    // Check if the user is an Admin
                    const userDocRef = db.doc(`/artifacts/${appId}/Users/${user.uid}`);
                    const userDoc = await userDocRef.get();

                    if (userDoc.exists && userDoc.data().Role === 'Admin') {
                        authStatus.textContent = `Signed in as Admin. Data entry is enabled.`;
                        authStatus.className = 'text-sm text-green-600 font-medium';
                        enableForm(true); // Enable the form
                    } else {
                        authStatus.textContent = `Access Denied. You are not an administrator.`;
                        authStatus.className = 'text-sm text-red-600 font-medium';
                        enableForm(false); // Disable the form
                    }
                } else {
                    // User is signed out
                    googleSigninBtn.classList.remove('hidden');
                    userProfileSection.style.display = 'none';
                    authStatus.textContent = 'Please sign in to continue.';
                    authStatus.className = 'text-sm text-gray-500';
                    enableForm(false); // Disable the form
                }
            });
        });

        // --- Authentication Functions ---
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                document.getElementById('status-message').innerHTML = `<p class="text-red-600">Sign-in failed. Please try again.</p>`;
            }
        }

        async function signOutUser() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Sign-Out failed:", error);
            }
        }

        // --- Helper to Enable/Disable the entire form ---
        function enableForm(isEnabled) {
            const saveBtn = document.getElementById('save-draw-btn');
            const formElements = document.getElementById('historical-form').elements;

            if (!saveBtn) return;

            saveBtn.disabled = !isEnabled;
            for (let i = 0; i < formElements.length; i++) {
                formElements[i].disabled = !isEnabled;
            }

            if (!isEnabled) {
                saveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                saveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        // --- Form Submission Handler ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            const statusMessage = document.getElementById('status-message');
            const saveBtn = document.getElementById('save-draw-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveSpinner = document.getElementById('save-spinner');

            statusMessage.innerHTML = '';

            saveBtn.disabled = true;
            saveBtnText.textContent = 'Saving...';
            saveSpinner.classList.remove('hidden');

            const monthInputValue = document.getElementById('draw-month').value;
            const winnerTicket = document.getElementById('chit-winner').value.trim();
            const consolationTickets = [
                document.getElementById('consolation-1').value.trim(),
                document.getElementById('consolation-2').value.trim(),
                document.getElementById('consolation-3').value.trim()
            ];
            
            const timestampValue = document.getElementById('draw-timestamp').value;
            
            // 1. First, check if any fields are empty
            if (!monthInputValue || !timestampValue || !winnerTicket || consolationTickets.some(t => !t)) {
                statusMessage.innerHTML = `<p class="text-red-600">Error: All fields are required.</p>`;
                resetSaveButton();
                return;
            }

            // 2. NEW VALIDATION: Check the format of all ticket numbers
            const ticketFormatRegex = /^SSC\d+$/;
            const isWinnerTicketValid = ticketFormatRegex.test(winnerTicket);
            const areConsolationTicketsValid = consolationTickets.every(ticket => ticketFormatRegex.test(ticket));

            if (!isWinnerTicketValid || !areConsolationTicketsValid) {
                statusMessage.innerHTML = `<p class="text-red-600">Error: All ticket numbers must start with 'SSC' followed only by numbers (e.g., SSC12345).</p>`;
                resetSaveButton(); // Assuming resetSaveButton is defined elsewhere
                return;
            }

            const [year, month] = monthInputValue.split('-');
            const date = new Date(year, month - 1);
            const monthAndYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });

            try {

                const drawTimestamp = new Date(timestampValue);
                await saveHistoricalWinner(winnerTicket, consolationTickets, monthAndYear, drawTimestamp);
                statusMessage.innerHTML = `<p class="text-green-600 font-bold">Success! Draw for ${monthAndYear} has been saved.</p>`;
                document.getElementById('historical-form').reset();
            } catch (error) {
                console.error("Error during historical save:", error);
                statusMessage.innerHTML = `<p class="text-red-600">Save Failed: ${error.message}</p>`;
            } finally {
                resetSaveButton();
            }
        }

        function resetSaveButton() {
            const saveBtn = document.getElementById('save-draw-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveSpinner = document.getElementById('save-spinner');
            saveBtn.disabled = false;
            saveBtnText.textContent = 'Save Draw';
            saveSpinner.classList.add('hidden');
        }

        // --- Helper and Save Functions ---
        async function getMemberDetails(ticketNumber) {
            const docRef = db.doc(`/artifacts/${appId}/public/data/SnehaNidhiSchemeMembers/${ticketNumber}`);
            const docSnap = await docRef.get();
            return docSnap.exists ? docSnap.data() : null;
        }

        async function saveHistoricalWinner(winnerTicket, consolationTickets, monthAndYear, drawTimestamp) {
            if (!auth.currentUser) throw new Error("User not authenticated.");

            // --- NEW: VALIDATION STEP ---
            // Check if the proposed Chit Winner has won the main prize before.
            const winnersCollectionRef = db.collection(`/artifacts/${appId}/public/data/SnehaNidhiWinners`);
            const snapshot = await winnersCollectionRef.get();

            for (const doc of snapshot.docs) {
                const drawData = doc.data();
                if (drawData.winners && Array.isArray(drawData.winners)) {
                    // Check if any winner in this past draw matches our criteria
                    const alreadyWon = drawData.winners.some(
                        pastWinner => pastWinner.prize === 'Chit Winner' && pastWinner.ticketNumber === winnerTicket
                    );

                    if (alreadyWon) {
                        // If a match is found, stop immediately and throw an error.
                        throw new Error(`Validation Failed: Ticket '${winnerTicket}' has already won the 'Chit Winner' prize in the ${drawData.monthAndYear} draw.`);
                    }
                }
            }
            // --- END OF VALIDATION STEP ---

            console.log(`Validation passed: Ticket ${winnerTicket} is a unique Chit Winner.`);

            const allWinnerTickets = [winnerTicket, ...consolationTickets];
            const winnersData = [];
            const prizeNames = ['Chit Winner', 'First Consolation Prize', 'Second Consolation Prize', 'Third Consolation Prize'];

            for (let i = 0; i < allWinnerTickets.length; i++) {
                const ticketNumber = allWinnerTickets[i];
                const memberDetails = await getMemberDetails(ticketNumber);
                winnersData.push({
                    prize: prizeNames[i],
                    ticketNumber: ticketNumber,
                    memberDetails: {
                        SNSMemberName: memberDetails?.SNSMemberName || 'N/A',
                        ChurchContactName: memberDetails?.ChurchContactName || 'N/A',
                        ChurchContactPhone: memberDetails?.ChurchContactPhone || 'N/A'
                    }
                });
            }

            const docId = monthAndYear.replace(/\s/g, '');
            const docRef = db.doc(`/artifacts/${appId}/public/data/SnehaNidhiWinners/${docId}`);

            await docRef.set({
                monthAndYear: monthAndYear,
                winners: winnersData,
                timestamp: drawTimestamp,
                userTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                userName: auth.currentUser.displayName || auth.currentUser.email
            });
        }
    </script>
</body>

</html>
