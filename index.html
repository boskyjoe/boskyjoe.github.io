<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raffle Winner Announcement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font globally and set a light background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* A soft, light blue-gray for the background */
        }

        /* Custom styles for button hover effects (Tailwind handles most, but adding a subtle scale) */
        .winner-button:hover:not(:disabled) {
            transform: scale(1.05); /* Slightly enlarge button on hover, but not if disabled */
        }

        /* Style for disabled buttons */
        .winner-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Style for the reset button */
        #reset-raffle-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10 px-4">
    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-4xl w-full text-center">
        <div class="mb-8">
            <div class="flex items-center justify-center md:justify-start mb-4">
                <div class="w-20 h-20 md:w-24 md:h-24 mr-4 md:mr-6 flex-shrink-0">
                    <img src="https://static.wixstatic.com/media/df2113_f71b21a1906c4d2bace3f797f5a6a8bb~mv2.png/v1/crop/x_5,y_0,w_365,h_315/fill/w_87,h_75,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/LogoDesign-II%20(1)_edited.png" 
                         alt="St. Sebastian's Church Logo" 
                         class="w-full h-full object-contain rounded-full">
                </div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 text-left">
                    St. Sebastian's Church Raffle Winner Announcement
                </h1>
            </div>
            <div class="text-gray-600 text-sm md:text-base mb-8 text-left md:ml-28">
                <p>No:184/C, New Byppanahalli Extn, Indiranagar, Bengaluru â€“ 560038</p>
                <p>+91 7090424365 | stsebastianssmc@gmail.com</p>
            </div>
        </div>

        <p class="text-lg text-gray-700 mb-10">
            Congratulations to all our lucky winners! Thank you for participating in our church raffle.
            Click the "Generate Winners" button for each place to reveal the winning ticket numbers.
            <strong class="text-red-600">1st Place winners are drawn from 'winners.txt'. 2nd and 3rd Place winners are drawn from 'winners1.txt'. Each ticket can only win once!</strong>
        </p>

        <div id="status-message" class="text-center text-lg font-semibold text-gray-600 mb-6">
            Loading ticket data...
        </div>

        <div class="winner-section bg-gradient-to-br from-yellow-400 to-yellow-600 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-3xl font-bold text-white mb-6 flex items-center justify-center">
                <span class="inline-block bg-white text-yellow-600 rounded-full px-4 py-1 mr-3 text-2xl">ðŸ¥‡</span> 1st Place Winners
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="winner-card bg-yellow-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800">Primary Winner</h3>
                    <p id="first-primary" class="text-3xl font-bold text-yellow-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-yellow-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800">Secondary Winner</h3>
                    <p id="first-secondary" class="text-3xl font-bold text-yellow-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-yellow-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800">Third Winner</h3>
                    <p id="first-third" class="text-3xl font-bold text-yellow-900 mt-2">---</p>
                </div>
            </div>
            <button id="generate-first" class="winner-button px-8 py-3 bg-yellow-700 text-white font-semibold rounded-full shadow-lg hover:bg-yellow-800 transition duration-300 ease-in-out" disabled>
                Generate 1st Place Winners
            </button>
        </div>

        <div class="winner-section bg-gradient-to-br from-gray-400 to-gray-600 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-3xl font-bold text-white mb-6 flex items-center justify-center">
                <span class="inline-block bg-white text-gray-600 rounded-full px-4 py-1 mr-3 text-2xl">ðŸ¥ˆ</span> 2nd Place Winners
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="winner-card bg-gray-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800">Primary Winner</h3>
                    <p id="second-primary" class="text-3xl font-bold text-gray-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-gray-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800">Secondary Winner</h3>
                    <p id="second-secondary" class="text-3xl font-bold text-gray-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-gray-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800">Third Winner</h3>
                    <p id="second-third" class="text-3xl font-bold text-gray-900 mt-2">---</p>
                </div>
            </div>
            <button id="generate-second" class="winner-button px-8 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:bg-gray-800 transition duration-300 ease-in-out" disabled>
                Generate 2nd Place Winners
            </button>
        </div>

        <div class="winner-section bg-gradient-to-br from-amber-600 to-amber-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold text-white mb-6 flex items-center justify-center">
                <span class="inline-block bg-white text-amber-800 rounded-full px-4 py-1 mr-3 text-2xl">ðŸ¥‰</span> 3rd Place Winners
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="winner-card bg-amber-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-amber-800">Primary Winner</h3>
                    <p id="third-primary" class="text-3xl font-bold text-amber-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-amber-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-amber-800">Secondary Winner</h3>
                    <p id="third-secondary" class="text-3xl font-bold text-amber-900 mt-2">---</p>
                </div>
                <div class="winner-card bg-amber-100 p-4 rounded-md shadow-md">
                    <h3 class="text-xl font-semibold text-amber-800">Third Winner</h3>
                    <p id="third-third" class="text-3xl font-bold text-amber-900 mt-2">---</p>
                </div>
            </div>
            <button id="generate-third" class="winner-button px-8 py-3 bg-amber-900 text-white font-semibold rounded-full shadow-lg hover:bg-amber-950 transition duration-300 ease-in-out" disabled>
                Generate 3rd Place Winners
            </button>
        </div>

        <button id="reset-raffle-btn" class="mt-10 px-8 py-3 bg-red-600 text-white font-semibold rounded-full shadow-lg hover:bg-red-700 transition duration-300 ease-in-out">
            Reset Raffle
        </button>
    </div>

    <script>
        let raffleTicketsWinners = []; // Will be populated from winners.txt
        let raffleTicketsWinners1 = []; // Will be populated from winners1.txt
        let allTimePickedTickets = new Set(); // Global set to store all tickets ever picked

        const statusMessageElement = document.getElementById('status-message');
        const generateButtons = document.querySelectorAll('.winner-button');
        const resetRaffleBtn = document.getElementById('reset-raffle-btn');

        /**
         * Disables all "Generate Winners" buttons.
         */
        function disableButtons() {
            generateButtons.forEach(button => button.disabled = true);
        }

        /**
         * Enables all "Generate Winners" buttons.
         */
        function enableButtons() {
            generateButtons.forEach(button => button.disabled = false);
        }

        /**
         * Resets the displayed winner numbers to "---".
         */
        function clearDisplayedWinners() {
            document.getElementById('first-primary').textContent = '---';
            document.getElementById('first-secondary').textContent = '---';
            document.getElementById('first-third').textContent = '---';
            document.getElementById('second-primary').textContent = '---';
            document.getElementById('second-secondary').textContent = '---';
            document.getElementById('second-third').textContent = '---';
            document.getElementById('third-primary').textContent = '---';
            document.getElementById('third-secondary').textContent = '---';
            document.getElementById('third-third').textContent = '---';
        }

        /**
         * Fetches ticket numbers from a text file and parses them into an array of strings.
         * Expects alphanumeric strings to be separated by newlines or commas.
         * @param {string} filePath - The path to the text file.
         * @returns {Promise<Array<string>>} A promise that resolves with an array of alphanumeric strings.
         */
        async function fetchTicketNumbers(filePath) {
            try {
                const fullUrl = new URL(filePath, window.location.href).href;
                console.log(`Attempting to fetch from: ${fullUrl}`);

                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filePath} (HTTP status: ${response.status}): ${response.statusText}`);
                }
                const text = await response.text();
                console.log(`Raw content of ${filePath}:`, text);

                // Split by newline or comma, filter out empty strings, and trim whitespace.
                const tickets = text.split(/[\n,]+/)
                                   .map(s => s.trim())
                                   .filter(s => s !== '');

                console.log(`Parsed tickets from ${filePath}:`, tickets);
                return tickets;
            } catch (error) {
                console.error(`Error fetching ${filePath}:`, error);
                statusMessageElement.textContent = `Error loading ticket data from '${filePath}'. Please ensure the file exists in the same directory as your HTML, contains valid alphanumeric tickets (one per line or comma-separated), and is correctly formatted. It might also be a security restriction in this preview environment.`;
                disableButtons();
                throw error;
            }
        }

        /**
         * Initializes the application by fetching ticket data from external files.
         */
        async function initializeRaffleData() {
            statusMessageElement.textContent = "Loading ticket data...";
            disableButtons();
            clearDisplayedWinners(); // Clear any previous winners on load

            try {
                const [winnersData, winners1Data] = await Promise.all([
                    fetchTicketNumbers('winners.txt'),
                    fetchTicketNumbers('winners1.txt')
                ]);

                raffleTicketsWinners = winnersData;
                raffleTicketsWinners1 = winners1Data;

                // Check if the loaded arrays have enough unique tickets for picking
                // winners.txt needs at least 3 tickets for 1st place.
                // winners1.txt needs at least 6 tickets (3 for 2nd place + 3 for 3rd place).
                if (raffleTicketsWinners.length < 3 || raffleTicketsWinners1.length < 6) {
                    statusMessageElement.textContent = `Error: Not enough unique ticket numbers available. 'winners.txt' has ${raffleTicketsWinners.length} tickets (needs at least 3 for 1st place). 'winners1.txt' has ${raffleTicketsWinners1.length} tickets (needs at least 6 for 2nd and 3rd place). Please populate your files with more unique alphanumeric tickets.`;
                    disableButtons();
                    return;
                }

                statusMessageElement.textContent = "Ticket data loaded successfully! Click a button to generate winners.";
                enableButtons();
            } catch (error) {
                // Error handled in fetchTicketNumbers, just ensure buttons are disabled
                disableButtons();
            }
        }

        /**
         * Generates a random integer between min (inclusive) and max (inclusive).
         * This function is a helper to pick a random index from an array.
         * @param {number} min - The minimum value for the random number (usually 0 for array index).
         * @param {number} max - The maximum value for the random number (usually array.length - 1).
         * @returns {number} A random integer within the specified range.
         */
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Picks a single unique random element from a source array, ensuring it's not
         * already present in a set of 'currentDrawAvoidTickets' (for uniqueness within this draw)
         * AND 'allTimePickedTickets' (for overall uniqueness).
         * @param {Array<string>} sourceArray - The array of alphanumeric tickets to pick from.
         * @param {Set<string>} currentDrawAvoidTickets - A Set containing tickets that have already been picked
         * for the current prize category (Primary, Secondary, Third for one place) during this single button click.
         * @returns {string} A unique random alphanumeric ticket, or "N/A" if no unique ticket can be found.
         */
        function pickSingleUniqueTicket(sourceArray, currentDrawAvoidTickets) {
            // Filter out tickets that are already in the global set OR the current draw's local set
            const availableTickets = sourceArray.filter(ticket =>
                !allTimePickedTickets.has(ticket) && !currentDrawAvoidTickets.has(ticket)
            );

            if (availableTickets.length === 0) {
                console.warn("Not enough unique tickets available in the source pool for this pick, considering all previously picked tickets.");
                return "N/A"; // Return "N/A" if no unique ticket can be found
            }

            // Pick a random index from the available tickets
            const randomIndex = getRandomNumber(0, availableTickets.length - 1);
            const pickedTicket = availableTickets[randomIndex];

            // Add to the local set for this draw's uniqueness
            currentDrawAvoidTickets.add(pickedTicket);
            // Add to the global set for all-time uniqueness
            allTimePickedTickets.add(pickedTicket);

            return pickedTicket;
        }

        /**
         * Updates the display elements for a specific place's winners (Primary, Secondary, Third).
         * It now picks winners based on the specified file source for each place.
         * @param {string} placePrefix - The prefix for the winner IDs (e.g., 'first', 'second', 'third').
         * This helps in targeting the correct HTML elements.
         */
        function updateWinnersDisplay(placePrefix) {
            // Create a Set to keep track of tickets picked for the current place (Primary, Secondary, Third)
            // to ensure all three are unique from each other within this specific draw.
            const pickedTicketsForThisPlace = new Set();
            let sourceArrayForPlace;

            // Determine the source array based on the prize place
            if (placePrefix === 'first') {
                sourceArrayForPlace = raffleTicketsWinners;
            } else if (placePrefix === 'second' || placePrefix === 'third') {
                sourceArrayForPlace = raffleTicketsWinners1;
            } else {
                console.error("Invalid place prefix provided:", placePrefix);
                return; // Exit if invalid prefix
            }

            // Pick winners from the determined source array
            const primaryWinner = pickSingleUniqueTicket(sourceArrayForPlace, pickedTicketsForThisPlace);
            const secondaryWinner = pickSingleUniqueTicket(sourceArrayForPlace, pickedTicketsForThisPlace);
            const thirdWinner = pickSingleUniqueTicket(sourceArrayForPlace, pickedTicketsForThisPlace);

            // Get references to the specific HTML elements where the winners will be displayed
            const primaryElement = document.getElementById(`${placePrefix}-primary`);
            const secondaryElement = document.getElementById(`${placePrefix}-secondary`);
            const thirdElement = document.getElementById(`${placePrefix}-third`);

            // Update the text content of these elements.
            // A check is added to ensure the element exists before trying to update it.
            if (primaryElement) primaryElement.textContent = primaryWinner;
            if (secondaryElement) secondaryElement.textContent = secondaryWinner;
            if (thirdElement) thirdElement.textContent = thirdWinner;

            // Optional: Check if all possible tickets have been drawn and disable buttons if so
            // This check is now more complex as tickets are drawn from different pools.
            // For simplicity, we'll check if the global picked tickets count exceeds the total available tickets.
            // A more precise check would involve tracking available tickets per pool.
            const totalTicketsInWinners = new Set(raffleTicketsWinners).size;
            const totalTicketsInWinners1 = new Set(raffleTicketsWinners1).size;
            const overallTotalUniqueTickets = new Set([...raffleTicketsWinners, ...raffleTicketsWinners1]).size;

            if (allTimePickedTickets.size >= overallTotalUniqueTickets) {
                statusMessageElement.textContent = "All unique tickets have been drawn from both pools! Reset raffle to start again.";
                disableButtons();
            } else if (placePrefix === 'first' && allTimePickedTickets.size >= totalTicketsInWinners && allTimePickedTickets.size - (totalTicketsInWinners1 - (new Set(raffleTicketsWinners1).size - allTimePickedTickets.size)) >= totalTicketsInWinners) {
                // This condition is tricky. A simpler approach is to check if there are enough *remaining* tickets
                // in the relevant pool for the next draw.
                // For now, the general check above is sufficient.
            }
        }

        // Get references to the "Generate Winners" buttons for each place
        const generateFirstBtn = document.getElementById('generate-first');
        const generateSecondBtn = document.getElementById('generate-second');
        const generateThirdBtn = document.getElementById('generate-third');

        // Add event listeners to each button.
        // When a button is clicked, it calls `updateWinnersDisplay` with the appropriate prefix.
        if (generateFirstBtn) {
            generateFirstBtn.addEventListener('click', () => updateWinnersDisplay('first'));
        }
        if (generateSecondBtn) {
            generateSecondBtn.addEventListener('click', () => updateWinnersDisplay('second'));
        }
        if (generateThirdBtn) {
            generateThirdBtn.addEventListener('click', () => updateWinnersDisplay('third'));
        }

        // Add event listener for the Reset Raffle button
        if (resetRaffleBtn) {
            resetRaffleBtn.addEventListener('click', () => {
                allTimePickedTickets.clear(); // Clear all previously picked tickets
                clearDisplayedWinners(); // Reset displayed text
                initializeRaffleData(); // Re-initialize data and enable buttons
                statusMessageElement.textContent = "Raffle reset. Ticket data reloaded. Click a button to generate winners.";
            });
        }

        // Initialize data when the page loads
        document.addEventListener('DOMContentLoaded', initializeRaffleData);
    </script>
</body>
</html>
