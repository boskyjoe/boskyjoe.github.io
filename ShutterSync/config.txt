rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Function to check if the authenticated user has an 'Admin' role.
    function is_admin() {
      return get(/databases/$(database)/documents/users_data/$(request.auth.uid)).data.role == 'Admin';
    }

    // Global rule: All operations require the user to be authenticated.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // Rules for the 'users_data' collection:
    // Path: /users_data/{userId}
    match /users_data/{userId} {
      allow get: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      allow update, delete: if is_admin();
    }

    // Rules for Country Mapping:
    // New Path: /app_metadata/countries_states/{docId}
    match /app_metadata/countries_states/{docId} {
      allow read, create, update, delete: if is_admin();
    }

    // Rules for Currencies:
    // New Path: /app_metadata/app_settings/currencies_data/{docId}
    match /app_metadata/app_settings/currencies_data/{docId} {
      allow read, create, update, delete: if is_admin();
    }

    // Rules for Price Books:
    // New Path: /app_metadata/app_settings/price_books_data/{docId}
    match /app_metadata/app_settings/price_books_data/{docId} {
      allow read, create, update, delete: if is_admin();
    }

    // Rules for the 'customers' collection: (No change)
    // Path: /customers/{customerId}
    match /customers/{customerId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // Rules for the 'opportunities' collection: (No change)
    // Path: /opportunities/{opportunityId}
    match /opportunities/{opportunityId} {
      allow read: if request.auth.uid == resource.data.creatorId || is_admin();
      allow create: if request.auth.uid == request.resource.data.creatorId;
      allow update, delete: if request.auth.uid == resource.data.creatorId || is_admin();
    }

    // Rules for sub-collections of 'opportunities': (No change)
    // Paths: /opportunities/{opportunityId}/lines/{lineId}, /opportunities/{opportunityId}/contacts/{contactId}, etc.
    match /opportunities/{opportunityId}/{subcollection}/{docId} {
      allow read, create, update, delete: if get(/databases/$(database)/documents/opportunities/$(opportunityId)).data.creatorId == request.auth.uid || is_admin();
    }
  }
}
